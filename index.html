<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²¸ã™AI</title>
    <style id="mod-style">
        :root {
            --main-color: #007bff;
        }

        body {
            font-family: sans-serif;
            background: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: 0.3s;
            background-size: cover;
            background-position: center;
        }

        #chat-container {
            width: 100%;
            max-width: 450px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            line-height: 1.4;
        }

        .user-msg {
            background: var(--main-color);
            color: white;
            align-self: flex-end;
        }

        .ai-msg {
            background: #eee;
            align-self: flex-start;
        }

        .input-area {
            display: flex;
            padding: 15px;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .panel {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 410px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .mod-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: 0.2s;
            margin-top: 5px;
        }

        .btn-blue {
            background: #007bff;
            color: white;
        }

        .btn-green {
            background: #28a745;
            color: white;
        }

        .btn-red {
            background: #dc3545;
            color: white;
        }

        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 15px 0;
        }
    </style>
</head>

<body id="body-bg">

    <div id="chat-container">
        <div style="padding:15px; background:#222; color:white; display:flex; align-items:center;">
            <img id="ai-img" src=""
                style="width:40px; height:40px; border-radius:50%; margin-right:10px; background:#fff; object-fit: cover;">
            <strong id="ai-name">AI</strong>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <input type="text" id="user-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                style="flex:1; border-radius: 20px; margin-top:0;">
            <button class="btn btn-blue" onclick="chat()" style="margin-left:10px; margin-top:0;">é€ä¿¡</button>
        </div>
    </div>

    <div class="panel">
        <strong>âš™ï¸ AIã®å€‹åˆ¥è¨­å®š</strong>
        <hr>
        åå‰: <input type="text" id="edit-name" placeholder="åå‰ã‚’å¤‰æ›´">
        ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´: <input type="file" id="edit-img-file" accept="image/*">
        èƒŒæ™¯ç”»åƒURL: <input type="text" id="edit-bg-url" placeholder="https://...">
        <button class="btn btn-blue" onclick="savePersonalSettings()" style="width:100%;">è¨­å®šã‚’ä¿å­˜ã—ã¦é©ç”¨</button>
        <hr>
        <strong>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</strong><br>
        <button class="btn btn-green" onclick="exportMemory()">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <div style="margin-top:10px;">
            <small>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ:</small>
            <input type="file" id="memory-import" accept=".json" onchange="importMemory()">
        </div>
    </div>

    <div class="panel">
        <strong>ğŸ“¦ å…¬é–‹Modãƒªã‚¹ãƒˆ</strong>
        <hr>
        <div id="mod-list-display">
            <small>Modã‚’èª­ã¿è¾¼ã¿ä¸­...</small>
        </div>
    </div>

    <script>
        // è¨˜æ†¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        let currentData = JSON.parse(localStorage.getItem('ai_user_data_v4') || '{"aiName":"AI","brain":{},"aiImage":"","backgroundImage":""}');

        // ç®¡ç†è€…ãŒæ›´æ–°ã™ã‚‹ãƒªã‚¹ãƒˆ
        const PUBLIC_MODS = [
            { name: "æ¨™æº–AI", path: "mods/default.json" }
        ];

        function updateView() {
            document.getElementById('ai-name').innerText = currentData.aiName;
            document.getElementById('ai-img').src = currentData.aiImage || "https://placehold.jp/150x150.png?text=AI";
            if (currentData.backgroundImage) {
                document.body.style.backgroundImage = `url(${currentData.backgroundImage})`;
            } else {
                document.body.style.backgroundImage = "none";
            }
            // è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('edit-name').value = currentData.aiName;
            document.getElementById('edit-bg-url').value = currentData.backgroundImage || "";
        }

        // è¨­å®šã‚’ä¿å­˜
        function savePersonalSettings() {
            const newName = document.getElementById('edit-name').value;
            const bgUrl = document.getElementById('edit-bg-url').value;
            const imgFile = document.getElementById('edit-img-file').files[0];

            currentData.aiName = newName;
            currentData.backgroundImage = bgUrl;

            if (imgFile) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentData.aiImage = e.target.result;
                    finalizeSave();
                };
                reader.readAsDataURL(imgFile);
            } else {
                finalizeSave();
            }
        }

        function finalizeSave() {
            localStorage.setItem('ai_user_data_v4', JSON.stringify(currentData));
            updateView();
            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
        }

        // Modã®ãƒ­ãƒ¼ãƒ‰
        async function loadModFromServer(path) {
            try {
                const response = await fetch(path);
                const modJson = await response.json();
                // å­¦ç¿’å†…å®¹(brain)ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã‹ä¸Šæ›¸ãã™ã‚‹ã‹é¸ã¹ã‚‹ãŒã€ã“ã“ã§ã¯åˆ†ã‹ã‚Šã‚„ã™ãä¸Šæ›¸ã
                currentData = modJson;
                localStorage.setItem('ai_user_data_v4', JSON.stringify(currentData));
                updateView();
                alert("Modã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼");
            } catch (err) { alert("Modèª­ã¿è¾¼ã¿å¤±æ•—"); }
        }

        function displayModList() {
            const listDiv = document.getElementById('mod-list-display');
            listDiv.innerHTML = "";
            PUBLIC_MODS.forEach(mod => {
                const item = document.createElement('div');
                item.className = 'mod-item';
                item.innerHTML = `<span>${mod.name}</span><button class="btn btn-blue" onclick="loadModFromServer('${mod.path}')">ãƒ­ãƒ¼ãƒ‰</button>`;
                listDiv.appendChild(item);
            });
        }

        function exportMemory() {
            const blob = new Blob([JSON.stringify(currentData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${currentData.aiName}_data.json`;
            a.click();
        }

        function importMemory() {
            const file = document.getElementById('memory-import').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                currentData = JSON.parse(e.target.result);
                localStorage.setItem('ai_user_data_v4', JSON.stringify(currentData));
                updateView();
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
            };
            reader.readAsText(file);
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯
        function learn(text) {
            let b = currentData.brain;
            for (let i = 0; i < text.length - 1; i++) {
                let c = text[i], n = text[i + 1];
                if (!b[c]) b[c] = [];
                b[c].push(n);
            }
            localStorage.setItem('ai_user_data_v4', JSON.stringify(currentData));
        }

        function generateReply(input) {
            let b = currentData.brain;
            let keys = Object.keys(b);
            if (keys.length === 0) return "......";
            let curr = input[0] && b[input[0]] ? input[0] : keys[Math.floor(Math.random() * keys.length)];
            let res = "";
            for (let i = 0; i < 20; i++) {
                if (!curr) break;
                res += curr;
                curr = b[curr] ? b[curr][Math.floor(Math.random() * b[curr].length)] : null;
            }
            return res;
        }

        function chat() {
            const input = document.getElementById('user-input');
            if (!input.value.trim()) return;
            document.getElementById('messages').innerHTML += `<div class="msg user-msg">ã‚ãªãŸ: ${input.value}</div>`;
            const reply = generateReply(input.value);
            learn(input.value);
            setTimeout(() => {
                document.getElementById('messages').innerHTML += `<div class="msg ai-msg"><strong>${currentData.aiName}:</strong> ${reply}</div>`;
                document.getElementById('messages').scrollTop = 9999;
            }, 500);
            input.value = '';
        }

        updateView();
        displayModList();
    </script>
</body>

</html>