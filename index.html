<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>貸すAI</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #chat-container { width: 100%; max-width: 400px; height: 500px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid #ddd; }
        .ai-info { display: flex; align-items: center; padding: 10px; background: #eee; }
        #ai-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .input-area { display: flex; padding: 10px; }
        input[type="text"] { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        button { margin-left: 5px; padding: 8px 15px; background: #0084ff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .settings { margin-top: 20px; background: white; padding: 15px; border-radius: 10px; width: 100%; max-width: 400px; font-size: 0.9em; }
    </style>
</head>
<body>

<div id="chat-container">
    <div class="ai-info">
        <img id="ai-img" src="https://placehold.jp/150x150.png">
        <strong id="ai-name">AI</strong>
    </div>
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="user-input" placeholder="何か話しかけて...">
        <button onclick="chat()">送信</button>
    </div>
</div>

<div class="settings">
    <strong>設定</strong><br>
    名前: <input type="text" id="set-name" value="AI"><br>
    画像URL: <input type="text" id="set-image" value="https://placehold.jp/150x150.png"><br>
    <button onclick="saveSettings()">設定を保存</button>
</div>

<script>
    // 記憶をブラウザから読み込む
    let brain = JSON.parse(localStorage.getItem('ai_brain') || '{}');
    let config = JSON.parse(localStorage.getItem('ai_config') || '{"name":"AI","image":"https://placehold.jp/150x150.png"}');

    function updateDisplay() {
        document.getElementById('ai-name').innerText = config.name;
        document.getElementById('ai-img').src = config.image;
    }

    function saveSettings() {
        config.name = document.getElementById('set-name').value;
        config.image = document.getElementById('set-image').value;
        localStorage.setItem('ai_config', JSON.stringify(config));
        updateDisplay();
        alert("設定を保存しました！");
    }

    function learn(text) {
        if (text.length < 2) return;
        for (let i = 0; i < text.length - 1; i++) {
            let c = text[i], n = text[i+1];
            if (!brain[c]) brain[c] = [];
            brain[c].push(n);
        }
        let last = text[text.length - 1];
        if (!brain[last]) brain[last] = [];
        brain[last].push(null);
        localStorage.setItem('ai_brain', JSON.stringify(brain));
    }

    function generateReply(input) {
        let keys = Object.keys(brain);
        if (keys.length === 0) return "まだ何も知らないよ...";
        
        let candidates = input.split('').filter(c => brain[c]);
        let curr = candidates.length > 0 ? candidates[Math.floor(Math.random() * candidates.length)] : keys[Math.floor(Math.random() * keys.length)];
        
        let res = "";
        for (let i = 0; i < 30; i++) {
            if (!curr) break;
            res += curr;
            let nexts = brain[curr];
            curr = nexts[Math.floor(Math.random() * nexts.length)];
        }
        return res;
    }

    function chat() {
        const inputElem = document.getElementById('user-input');
        const text = inputElem.value.trim();
        if (!text) return;

        const msgDiv = document.getElementById('messages');
        msgDiv.innerHTML += `<div><strong>あなた:</strong> ${text}</div>`;
        
        const reply = generateReply(text);
        learn(text);
        
        setTimeout(() => {
            msgDiv.innerHTML += `<div><strong>${config.name}:</strong> ${reply}</div>`;
            msgDiv.scrollTop = msgDiv.scrollHeight;
        }, 500);

        inputElem.value = '';
    }

    updateDisplay();
</script>
</body>
</html>