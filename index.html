<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chaos Conference Ultimate</title>
    <style>
        :root {
            --main-color: #007bff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f7f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: 0.3s;
            background-size: cover;
            background-position: center;
        }

        /* UI Components */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background: #ddd;
            font-weight: bold;
            font-size: 0.9em;
            transition: 0.2s;
        }

        .tab-btn.active {
            background: var(--main-color);
            color: white;
            transform: scale(1.05);
        }

        .member-panel {
            background: #1c1c1c;
            padding: 10px;
            border-radius: 12px;
            width: 260px;
            color: white;
        }

        .member-card {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #2a2a2a;
            margin: 6px 0;
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
        }

        .member-card img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }


        #chat-container {
            width: 100%;
            max-width: 500px;
            height: 650px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }


        /* Chat Bubbles */
        .chat-row {
            display: flex;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-row.right {
            flex-direction: row-reverse;
        }

        .chat-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 8px;
            border: 1px solid #ccc;
            background: white;
            flex-shrink: 0;
        }

        .msg-content {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        .msg-name {
            font-size: 0.7em;
            color: #666;
            margin-bottom: 2px;
            margin-left: 5px;
        }

        .right .msg-name {
            text-align: right;
            margin-right: 5px;
        }

        .msg-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 0.95em;
        }

        .right .msg-bubble {
            background: var(--main-color);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .left .msg-bubble {
            background: #eee;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        /* Controls */
        .input-area {
            display: flex;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 5px;
            color: white;
            transition: 0.2s;
            white-space: nowrap;
        }

        .btn-blue {
            background: #007bff;
        }

        .btn-green {
            background: #28a745;
        }

        .btn-red {
            background: #dc3545;
        }

        .btn-danger {
            background: #ff4444;
            font-weight: bold;
        }

        .btn:hover {
            opacity: 0.8;
        }

        /* Conference Settings Overlay */
        #conf-settings {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            overflow-y: auto;
            display: none;
            z-index: 10;
        }

        .section-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
            border-bottom: 2px solid #eee;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
        }

        .clone-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            animation: fadeIn 0.2s;
        }

        .clone-item input {
            padding: 5px 10px;
            margin-right: 5px;
            flex: 1;
        }

        .mod-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f9f9f9;
        }

        .mod-item input[type="checkbox"] {
            transform: scale(1.3);
            margin-right: 10px;
        }

        /* Panel */
        .panel {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            width: 100%;
            max-width: 460px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .panel.active {
            display: block;
        }

        input[type="file"] {
            width: 100%;
            margin-top: 5px;
        }

        #factionBar {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #111, #222);
            display: flex;
            pointer-events: auto;

            /* æ¨ªä¸¦ã³ã®ãƒ™ãƒ¼ã‚¹ */
            flex-wrap: wrap;
            /* ã¯ã¿å‡ºã—ãŸã‚‰æ”¹è¡Œ */
            gap: 10px;
            /* ã‚¢ã‚¤ãƒ†ãƒ é–“ã®é–“éš” */
            padding: 8px;
            font-size: 13px;
            z-index: 10;
        }


        .factionBox {
            background: #1e1e1e;
            border-radius: 8px;
            position: relative;
            z-index: 20000;

            padding: 6px 10px;
            min-width: 140px;
            color: #ddd;
            box-shadow: 0 0 6px rgba(0, 0, 0, .6);
        }

        .factionDead {
            opacity: .4;
            filter: grayscale(1);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .history-panel {
            width: 90%;
            max-width: 900px;
            height: 80%;
            background: #1a1a1a;
            color: #fff;
            border: 2px solid #444;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .history-header {
            padding: 15px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒªã‚¹ãƒˆï¼‰ */
        .history-sidebar {
            width: 200px;
            overflow-y: auto;
            border-right: 1px solid #444;
            background: #222;
        }

        .history-item {
            padding: 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: 0.2s;
        }

        .history-item:hover {
            background: #333;
        }

        .history-item.active {
            background: #444;
            border-left: 4px solid #00d2ff;
        }

        .history-date {
            font-size: 0.8em;
            color: #888;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .history-main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .factionBox {
            background: #333;
            border-radius: 14px;
            padding: 10px;
            margin: 8px;
        }

        .faction-ui-btn {
            width: 100%;
            border: none;
            border-radius: 8px;
            background: #333;
            color: white;
            padding: 4px;
            cursor: pointer;
            margin: 4px 0;
            position: relative;
            z-index: 30000;
        }

        .faction-leader-wrap {
            display: flex;
            justify-content: center;
            margin: 8px 0;
        }

        .faction-leader-card {
            text-align: center;
            background: white;
            padding: 8px;
            border-radius: 12px;
            width: 120px;
        }

        .faction-leader-card img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
        }

        .leader-name {
            color: #111;
            font-weight: bold;
        }

        .member-name {
            color: #111;
            font-weight: bold;
        }

        .faction-members-wrap {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .faction-member-card {
            width: 55px;
            background: white;
            border-radius: 10px;
            padding: 4px;
            text-align: center;
            font-size: 12px;
        }

        .faction-member-card img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }


        /* VSè¡¨ç¤ºï¼ˆæ±ºæˆ¦æ¼”å‡ºï¼‰ */
        .vs-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #111;
            border-radius: 10px;
        }

        .candidate-big {
            text-align: center;
            width: 150px;
        }

        .candidate-big img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #555;
        }

        .winner-glow img {
            border-color: #ffd700;
            box-shadow: 0 0 20px #ffd700;
        }

        .vs-text {
            font-size: 2em;
            font-weight: bold;
            margin: 0 30px;
            color: #ff4444;
            font-style: italic;
        }

        .vote-count-big {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 5px;
        }

        /* æŠ•ç¥¨è©³ç´°ãƒªã‚¹ãƒˆ */
        .vote-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .candidate-card {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .voter-icons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .voter-mini {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid #666;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .faction-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20000;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
        }

        .faction-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .faction-modal-window {
            background: #222;
            color: white;
            border-radius: 16px;
            padding: 16px;
            min-width: 320px;
            max-width: 520px;

            max-height: 80vh;
            /* â† ç”»é¢ã®8å‰²ã¾ã§ */
            overflow-y: auto;
            /* â† ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */

            transform: scale(.85);
            opacity: 0;
            transition: .25s ease;
        }


        .faction-modal.show .faction-modal-window {
            transform: scale(1);
            opacity: 1;
        }

        .faction-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            float: right;
            cursor: pointer;
        }

        .member-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .member-modal.active {
            display: flex;
        }

        .member-modal-bg {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, .55);
        }

        .member-modal-window {
            position: relative;
            background: #222;
            color: white;
            padding: 14px;
            border-radius: 16px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;

            transform: scale(.85);
            opacity: 0;
            transition: .25s ease;
        }

        .member-modal.active .member-modal-window {
            transform: scale(1);
            opacity: 1;
        }

        .member-list {
            margin-top: 8px;
        }

        .member-card {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #2a2a2a;
            margin: 6px 0;
            padding: 6px;
            border-radius: 8px;
            cursor: pointer;
        }

        .member-card img {
            width: 34px;
            height: 34px;
            border-radius: 50%;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ */
        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 450px;
            color: #333;
        }

        .custom-modal-body {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .edit-inputs {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .edit-inputs label {
            font-size: 0.85em;
            font-weight: bold;
            color: #555;
        }

        .edit-inputs input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* å³å´ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        .edit-preview-area {
            width: 120px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #eee;
            padding-left: 20px;
        }

        #edit-m-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--main-color, #4A90E2);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .custom-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        /* è£åˆ¤å®˜ã®å€‹åˆ¥åˆ¤æ±ºãƒãƒƒãƒ— */
        .judge-tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            border: 1px solid gold;
            z-index: 10;
        }

        .trial-char:hover .judge-tooltip {
            opacity: 1;
        }

        /* è£åˆ¤ä¸­ã®æ¼”å‡ºç”¨ï¼šèƒŒæ™¯ã‚’å°‘ã—æºã‚‰ã™ãªã© */
        #trialStage {
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3);
        }
    </style>
</head>
<script src="https://js.puter.com/v2/"></script>

<body id="body-bg">

    <div class="tab-container">
        <button class="tab-btn active" onclick="switchMode('chat', this)">ğŸ’¬ è‚²æˆï¼†å¯¾è©±</button>
        <button class="tab-btn" onclick="switchMode('conference', this)">ğŸ¤– AIä¼šè­°</button>

        <button class="tab-btn" onclick="toggleSettings()">âš™ï¸ è¨­å®š</button>
    </div>

    <div id="chat-container">
        <div
            style="padding:12px; background:#222; color:white; display:flex; justify-content:space-between; align-items:center;">
            <span id="header-title">AI Chat Room</span>
            <div id="conf-header-controls" style="display:none;">
                <small style="color:#aaa; margin-right:10px;">å­¦ç¿’ä¸­...</small>

                <button id="conf-toggle-btn" class="btn btn-green" style="font-size:0.8em; padding:4px 10px;"
                    onclick="toggleConference()">é–‹å§‹ â–¶</button>
            </div>
        </div>

        <div id="messages"></div>

        <!-- æ´¾é–¥ãƒãƒ£ãƒƒãƒˆã¯ç‹¬ç«‹ -->




        <div id="conf-settings">
            <h3>ğŸ“‹ ä¼šè­°ãƒ¡ãƒ³ãƒãƒ¼ç·¨æˆ</h3>
            <button onclick="saveMeetingMembers()">ğŸ’¾ ãƒ¡ãƒ³ãƒãƒ¼ä¿å­˜</button>
            <p>ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å ´åˆ:</p><input type="file" onchange="loadMeetingMembers(this)">


            <div class="section-title">ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å‚åŠ </div>
            <div class="mod-item">
                <input type="checkbox" id="chk-user" checked>
                <span>ã‚ãªãŸ (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼)</span>
            </div>

            <div class="section-title">
                ğŸ§¬ ãƒã‚¤AI (ã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿)
                <button class="btn btn-blue" style="font-size:0.7em; padding:2px 8px; margin-left:10px;"
                    onclick="addMyAIClone()">+ è¿½åŠ </button>
                <button class="btn btn-blue" style="font-size:0.7em; padding:2px 8px; margin-left:10px;"
                    onclick="addMyAIClone_dummy()">
                    + ç”»åƒã¨åå‰ä»˜ãAIã‚’è¿½åŠ </button>
            </div>
            <div id="my-ai-clones-list">
            </div>

            <div class="section-title">ğŸ“¦ å…¬é–‹Mod AI</div>
            <div id="mod-list-select">
            </div>
        </div>



        <div class="input-area">
            <input type="text" id="user-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                onkeydown="if(event.key === 'Enter') sendMessage();">
            <button class="btn btn-blue" onclick="sendMessage()">é€ä¿¡</button>
        </div>
        <center>
            <div id="voteArea" style="margin-top:10px;"></div>
        </center>
        <div id="chairmanPanel" style="display:none; border:2px solid #888; padding:10px; margin-top:10px;">
            <b>ğŸ‘‘ æŒ‡å°è€…ãƒ»ãƒ‘ãƒãƒ«</b><br>
            <!-- ãƒ¡ãƒ³ãƒãƒ¼é¸æŠç”¨ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
            <!-- è­°é•·ç”¨æ“ä½œãƒ‘ãƒãƒ«ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
            <div id="chairman-panel"
                style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border: 2px solid #333; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 90%; max-width: 400px;">
                <h3 id="panel-title" style="margin-top: 0;">å¯¾è±¡ã‚’é¸æŠ</h3>

                <div style="margin-bottom: 10px;">
                    <button onclick="selectAll(true)" style="font-size: 11px;">å…¨é¸æŠ</button>
                    <button onclick="selectAll(false)" style="font-size: 11px;">è§£é™¤</button>
                </div>

                <div id="panel-checkboxes"
                    style="max-height: 200px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; border: 1px solid #ddd; padding: 10px; background: #fdfdfd;">
                    <!-- ã“ã“ã«å‹•çš„ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå…¥ã‚‹ -->
                </div>

                <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closePanel()" style="background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="panel-confirm-btn" onclick=""
                        style="background: #ff4444; color: white; font-weight: bold; padding: 5px 15px;">å®Ÿè¡Œ</button>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã®æ“ä½œãƒœã‚¿ãƒ³ -->
            <button onclick="openKickPanel()">è¿½æ”¾ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            <button onclick="openReleasePanel()">é‡ˆæ”¾ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>
            <button onclick="openRecommendPanel()">å¾Œç¶™è€…ã‚’æ¨è–¦</button>
            <button onclick="chairmanResign()">è¾ä»»</button>
            <!-- æ‹›å¾…ç”¨ãƒ‘ãƒãƒ«ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œç‰ˆ -->
            <div id="invite-panel"
                style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; background: white; padding: 20px; border: 2px solid #333; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); width: 90%; max-width: 400px;">
                <h3 style="margin-top: 0;">ğŸ‘¥ æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</h3>

                <!-- åå‰å…¥åŠ› -->
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #666;">åå‰:</label>
                    <input type="text" id="invite-name-input" style="width: 100%; padding: 8px; box-sizing: border-box;"
                        placeholder="åå‰ã‚’å…¥åŠ›" oninput="updateInvitePreview()">
                </div>

                <!-- ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒé¸æŠï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ -->
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #666;">ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ:</label>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 5px;">
                        <div style="flex: 1;">
                            <input type="file" id="invite-file-input" accept="image/*" style="display: none;"
                                onchange="handleFileSelect(event)">
                            <button onclick="document.getElementById('invite-file-input').click()"
                                style="width: 100%; padding: 5px; font-size: 12px;">ç”»åƒã‚’é¸æŠ...</button>
                            <button onclick="clearSelectedFile()"
                                style="width: 100%; margin-top: 5px; font-size: 10px; background: none; border: 1px solid #ccc;">ç”»åƒã‚’ã‚¯ãƒªã‚¢</button>
                        </div>
                        <img id="invite-icon-preview" src=""
                            style="width: 50px; height: 50px; border-radius: 50%; background: #eee; border: 1px solid #ccc; object-fit: cover;">
                    </div>
                    <small style="font-size: 10px; color: #888;">â€»æœªé¸æŠãªã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™</small>
                </div>

                <div style="margin-bottom: 10px;">
                    <label style="font-size: 12px; color: #666;">éå»ã®ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰å¾©å¸°:</label>
                    <select id="invite-select-pool" style="width: 100%; padding: 5px;"
                        onchange="syncInviteSelection(this.value)">
                        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                    </select>
                </div>

                <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeInvitePanel()" style="background: #ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button onclick="executeInvite()"
                        style="background: #4CAF50; color: white; font-weight: bold; padding: 5px 15px;">æ‹›å¾…ã‚’é€ä¿¡</button>
                </div>
            </div>
            <button onclick="openInvitePanel()">ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</button>




            <!-- ã“ã“ã«é«˜ã•åˆ¶é™ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨­å®š -->
            <div id="member-checkboxes" style="
                    max-height: 120px; 
                    overflow-y: auto; 
                    display: grid; 
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
                    gap: 5px; 
                    padding: 5px; 
                    background: white; 
                    border: 1px solid #ddd;
                ">
            </div>
        </div>

        <div id="status-panel"
            style="position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:8px;">
            <div>ç¾åœ¨ã®è­°é•·: <span id="ui-chairman-name">-</span></div>
            <div>æ€æƒ³: <span id="ui-ideology">-</span></div>
            <div>æ”¯æŒç‡: <progress id="ui-approval" value="50" max="100"></progress> <span id="ui-approval-text">50%</span>
            </div>
            <div>å…¥å›½ç®¡ç†å±€: <span id="ui-sakoku">é–‹å›½ä¸­</span></div>
        </div>
        <div id="history-modal"
            style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; max-width:500px; height:70vh; background:#1a1a1a; color:white; padding:20px; border-radius:15px; z-index:2000; overflow-y:auto; border:2px solid #444;">
            <h2 style="text-align:center; border-bottom:1px solid #444; padding-bottom:10px;">ğŸ“œ æ­´ä»£è­°é•·éŒ²</h2>
            <div id="history-list"></div>
            <button onclick="document.getElementById('history-modal').style.display='none'"
                style="width:100%; padding:10px; margin-top:20px; cursor:pointer; background:#444; color:white; border:none; border-radius:5px;">é–‰ã˜ã‚‹</button>
        </div>

        <button onclick="showHistory()"
            style="position:fixed; bottom:10px; right:10px; z-index:1000; padding:8px 15px; background:#333; color:white; border-radius:20px; border:1px solid #555;">ğŸ“œæ­´ä»£è­°é•·</button>


    </div>



    </div>
    <div id="historyModal" style="display:none;" class="modal-overlay">
        <div class="modal-content history-panel">
            <div class="history-header">
                <h2>ğŸ“œ å›½å®¶é¸æŒ™è¨˜éŒ²ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h2>
                <button onclick="closeHistory()" class="close-btn">Ã—</button>
            </div>
            <div class="history-body">
                <div id="historyList" class="history-sidebar"></div>
                <div id="historyDetail" class="history-main">
                    <p style="text-align:center; color:#aaa;">é–²è¦§ã—ãŸã„è¨˜éŒ²ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>
        </div>
    </div>
    <button onclick="openMemberModal()">ğŸ” ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¢ã™</button>
    <div id="memberModal" class="member-modal">
        <div class="member-modal-bg" onclick="closeMemberModal()"></div>

        <div class="member-modal-window">
            <h3>ğŸ” ãƒ¡ãƒ³ãƒãƒ¼æ¤œç´¢</h3>
            <input id="memberSearch" placeholder="åå‰ã§æ¤œç´¢..." oninput="renderMemberList()">
            <button onclick="openCreateMemberModal()" class="btn">â• æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>

            <div id="memberList" class="member-list"></div>

            <button onclick="closeMemberModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>


    <button onclick="openHistory()" style="position:fixed; bottom:10px; left:10px; z-index:999;">ğŸ“œ é¸æŒ™å±¥æ­´</button>
    <button onclick="openPrisonModal()" style="position:fixed; bottom:10px; left:105px; z-index:999;">åˆ‘å‹™æ‰€</button>
    <button onclick="openTownModal()" style="position:fixed; bottom:40px; left:10px; z-index:999;">éƒ½å¸‚</button>


    <div id="settings-panel" class="panel">
        <strong>âš™ï¸ åŸºæœ¬è¨­å®š</strong>
        <hr>
        ã‚ãªãŸã®åå‰: <input type="text" id="username" placeholder="ã‚ãªãŸ"><br>
        ã‚ãªãŸã®ã‚¢ã‚¤ã‚³ãƒ³: <input type="file" id="user-icon-file" accept="image/*"><br>
        <hr>
        AIã®åå‰: <input type="text" id="edit-ai-name">
        AIã‚¢ã‚¤ã‚³ãƒ³: <input type="file" id="edit-ai-file" accept="image/*">
        èƒŒæ™¯URL: <input type="text" id="edit-bg-url">
        <button class="btn btn-blue" onclick="saveSettings()" style="width:100%; margin-top:10px;">è¨­å®šä¿å­˜</button>

        <hr>
        <strong>ğŸ› ã‚°ãƒ«ãƒ¼ãƒ—ãƒ»å›½å®¶ã‚·ã‚¹ãƒ†ãƒ </strong><br>
        <label><input type="checkbox" id="chk-chairman" checked> è­°é•·ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹</label><br>
        ã‚¿ã‚¤ãƒˆãƒ«: <input type="text" id="chairman-title" value="è­°é•·"><br>
        <label><input type="checkbox" id="issakoku">å…¥å›½ç¦æ­¢</label><br>
        <label><input type="checkbox" id="npc-skip">NPCé¸æŒ™ã‚¹ã‚­ãƒƒãƒ—</label><br>
        <select id="election-mode">
            <option value="vote">é¸æŒ™ã§æ±ºå®š</option>
            <option value="manual">ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆå®Ÿé¨“çš„ï¼‰</option>

        </select>


        <hr>
        <strong>ğŸš¨ å±é™ºãªãƒœã‚¿ãƒ³</strong><br>
        <button class="btn btn-danger" onclick="resetMemory()">âš ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»</button>

        <hr>
        <strong>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</strong><br>
        <button class="btn btn-green" onclick="exportMemory()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <input type="file" id="memory-import" accept=".json" onchange="importMemory()" style="margin-top:5px;">

        <hr>
        <strong>ğŸ“¦ Modãƒ­ãƒ¼ãƒ‰</strong><br>
        <div id="mod-load-list"></div>

    </div>
    <div id="customMemberModal" class="modal-backdrop"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:25px; border-radius:15px; width:450px; display:flex; gap:20px; color:#333; position:relative;">

            <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                <h3 style="margin-top:0;">ğŸ‘¤ ãƒ¡ãƒ³ãƒãƒ¼ç·¨é›†</h3>

                <label style="font-size:0.8em; font-weight:bold;">åå‰</label>
                <input type="text" id="edit-m-name" style="padding:8px; border:1px solid #ddd; border-radius:5px;">

                <label style="font-size:0.8em; font-weight:bold;">æ€æƒ³ãƒ»ä¸»ç¾©</label>
                <input type="text" id="edit-m-ideology" style="padding:8px; border:1px solid #ddd; border-radius:5px;">

                <label style="font-size:0.8em; font-weight:bold;">ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="edit-m-url" placeholder="URLã‚’å…¥åŠ›"
                        style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px; font-size:0.8em;">
                    <button onclick="document.getElementById('edit-m-file').click()"
                        style="padding:5px 10px; cursor:pointer; background:#eee; border:1px solid #ccc; border-radius:5px;">ğŸ“</button>
                </div>
                <input type="file" id="edit-m-file" style="display:none;" accept="image/*"
                    onchange="previewUploadedImage(this)">

                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button onclick="closeCustomModal()"
                        style="flex:1; padding:10px; border:none; border-radius:5px; cursor:pointer; background:#ccc;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="save-custom-btn" onclick="saveCustomData()"
                        style="flex:1; padding:10px; border:none; border-radius:5px; cursor:pointer; background:var(--main-color, #4A90E2); color:white; font-weight:bold;">ä¿å­˜</button>
                </div>

                <button id="trial-btn" onclick="DeleteCustomChara()"
                    style="width:100%; margin-top:5px; padding:8px; border:1px solid #ff4d4d; color:#ff4d4d; background:none; border-radius:5px; cursor:pointer; font-size:0.8em;">
                    âš–ï¸ å‰Šé™¤
                </button>
            </div>

            <div
                style="width:120px; display:flex; flex-direction:column; align-items:center; justify-content:center; border-left:1px solid #eee; padding-left:15px;">
                <img id="edit-m-preview" src=""
                    style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid #4A90E2; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                <span style="font-size:0.7em; color:#888; margin-top:8px;">PREVIEW</span>
            </div>
        </div>
    </div>
    <div id="trialModal"
        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.95); z-index:9999; align-items:center; justify-content:center;">
        <div id="trialStage"
            style="width:95%; height:90vh; background:#1a1a1a; border:4px solid #d4af37; border-radius:20px; display:flex; flex-direction:column; overflow:hidden;">

            <div id="judgesArea"
                style="height:100px; display:flex; justify-content:center; gap:10px; padding:10px; background:rgba(255,255,255,0.05);">
            </div>

            <div style="flex:1; position:relative; display:flex; justify-content:center; align-items:center;">
                <div id="accuserArea" style="position:absolute; left:5%;"></div>
                <div id="defendantArea" style="transform:scale(1.3);"></div>
                <div id="accuserRightArea" style="position:absolute; right:5%;"></div>
            </div>

            <div id="audienceArea"
                style="height:110px; display:flex; justify-content:center; align-content:center; flex-wrap:wrap; gap:8px; padding:10px; background:rgba(0,0,0,0.5); border-top:1px solid #444;">
            </div>

            <div id="verdictArea"
                style="height:160px; background:#000; border-top:4px solid #d4af37; padding:15px; text-align:center;">
                <div id="judgeSpeakerName" style="color:gold; font-size:0.9em; margin-bottom:5px;"></div>
                <div id="verdictText" style="font-size:1.8em; font-weight:bold; color:white;"></div>
                <div id="verdictSubText" style="color:#888; font-size:0.8em;"></div>
            </div>
        </div>
    </div>
    <div id="townModal" class="modal-backdrop" style="display:none; z-index:7000; background:rgba(0,0,0,0.9);">
        <div
            style="width:95%; max-width:1200px; height:90vh; background:#2e7d32; border:10px solid #1b5e20; border-radius:20px; display:flex; flex-direction:column; position:relative; overflow:hidden;">

            <div
                style="padding:15px; background:#1b5e20; color:white; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0;">ğŸ˜ï¸ éƒ½å¸‚ã‚·ã‚¹ãƒ†ãƒ  v1.0</h2>
                <div id="townBreadcrumb" style="font-size:14px; color:gold;">è¡—å…¨ä½“ ï¼</div>
                <button onclick="closeTownModal()"
                    style="background:#f44336; border:none; color:white; padding:5px 15px; cursor:pointer;">é–‰ã˜ã‚‹</button>
            </div>

            <div id="townView"
                style="flex:1; padding:20px; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:20px;">
            </div>

            <div id="detailView"
                style="display:none; position:absolute; top:50px; left:0; width:100%; height:calc(100% - 50px); background:#333; z-index:10; padding:20px; overflow-y:auto;">
                <button onclick="backToTown()" style="margin-bottom:10px;">â¬… è¡—ã«æˆ»ã‚‹</button>
                <div id="detailContent"></div>
            </div>
        </div>
    </div>
    <div id="prisonModal" class="modal-backdrop" style="display:none; z-index:6000; background:rgba(0,0,0,0.85);">
        <div
            style="width:90%; max-width:1000px; height:85vh; background:#2c3e50; border:5px solid #7f8c8d; border-radius:10px; display:flex; flex-direction:column; color:#ecf0f1; font-family:serif;">

            <div
                style="padding:20px; background:#1a252f; border-bottom:3px solid #c0392b; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; color:#e74c3c;">â›“ï¸ åˆ‘å‹™æ‰€ ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ </h2>
                <button onclick="closePrisonModal()"
                    style="background:#e74c3c; color:white; border:none; padding:5px 15px; cursor:pointer;">é–‰ã˜ã‚‹</button>
            </div>

            <div style="flex:1; display:flex; overflow:hidden;">
                <div id="prisonerListArea"
                    style="width:300px; border-right:2px solid #34495e; overflow-y:auto; padding:10px; background:rgba(0,0,0,0.2);">
                </div>

                <div id="prisonDetailArea"
                    style="flex:1; padding:20px; background:url('https://www.transparenttextures.com/patterns/carbon-fibre.png'); position:relative;">
                    <div id="prisonRoomView" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="factionBar"></div>
    <div id="factionModal" class="faction-modal hidden">
        <div class="faction-modal-window">
            <button class="faction-close-btn" onclick="closeFactionModal()">âœ–</button>
            <div id="factionDetail"></div>
        </div>
    </div>




    <script>
        const input = document.getElementById('user-input');
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // --- ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ– ---
        let data = JSON.parse(localStorage.getItem('ai_data_v7') || JSON.stringify({
            userName: "ã‚ãªãŸ",
            userImage: "https://placehold.jp/150x150.png?text=YOU",
            aiName: "ãƒã‚¤AI",
            aiImage: "https://placehold.jp/150x150.png?text=AI",
            backgroundImage: "",
            brain: {}
        }));


        // windowç›´ä¸‹ã«é…ç½®ã—ã¦ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹
        window.loadSpecificBrain = function (input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const data = JSON.parse(text);

                    if (!data.brain) {
                        alert("ä¸æ­£ãªAIãƒ‡ãƒ¼ã‚¿ã§ã™");
                        return;
                    }

                    // âœ… brainã‹ã‚‰åå‰ç”Ÿæˆ
                    let name = data.aiName || generateName(data.brain);

                    // âœ… avatarç”Ÿæˆ
                    let avatar = `https://api.dicebear.com/7.x/personas/svg?seed=${encodeURIComponent(name)}`;

                    let newMember = {
                        type: "ai",
                        name,
                        image: avatar,
                        brain: JSON.parse(JSON.stringify(data.brain)),
                        fav: "",
                        ng: "",
                        isIndividual: true
                    };

                    // âœ… ç™»éŒ²
                    activeMembers.push(newMember);
                    renderMemberList();


                    console.log("Loaded AI:", newMember);
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ¤– ${name} ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, "", false);

                } catch (err) {
                    console.error(err);
                    alert("JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
                }
            };

            reader.readAsText(file);
        };




        window.toggleBrainFileBtn = function (select) {
            const item = select.closest('.clone-item');
            const area = item.querySelector('.brain-file-area');
            area.style.display = (select.value === 'individual') ? 'block' : 'none';
        };

        window.togglebrain = function (select) {
            const item = select.closest('.clone-item');
            const area = item.querySelector('.clone-brain-ai');

            // 3. ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®å€¤ã«ã‚ˆã£ã¦å‡¦ç†ã‚’å¤‰ãˆã‚‹
            if (select.value === "on") {
                area.textContent = "AIä½¿ç”¨ä¸­"; // è¡¨ç¤ºã™ã‚‹æ–‡å­—
                area.style.color = "blue";     // ã¤ã„ã§ã«è‰²ã‚‚å¤‰ãˆã¦ã¿ã‚‹
            } else {
                area.textContent = "åœæ­¢ä¸­";
                area.style.color = "gray";
            }

        };

        // Modå®šç¾©
        const PUBLIC_MODS = [
            { name: "æ¨™æº–AI", path: "mods/default.json" }
        ];

        let mode = 'chat';
        let conferenceRunning = false;
        let conferenceTimer = null;
        let activeMembers = [];
        let loadedModsData = [];
        let myAICloneCount = 0;
        let relations = {};

        const MOOD_PHRASES = {
            fight: ["ã¯ï¼Ÿ", "æ„å‘³ä¸æ˜ã€‚", "ãµã–ã‘ã‚‹ãªã€‚", "é•ã†ã€‚", "é»™ã‚Œã€‚"],
            friend: ["ã‚ã‹ã‚‹ï¼", "ç¢ºã‹ã«ã€‚", "æœ€é«˜ã ã­ã€‚", "è³›æˆï¼", "ã ã‚ˆã­ã€‚"]
        };

        // è¨˜æ†¶ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ï¼ˆwindowã«ç™»éŒ²ã—ã¦ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰


        window.onload = async () => {
            updateUI();
            renderModLoadList();
            updateStatusUI();
            // Modå…ˆèª­ã¿
            for (let mod of PUBLIC_MODS) {
                try {
                    const res = await fetch(mod.path);
                    if (res.ok) loadedModsData.push(await res.json());
                } catch (e) { }
            }
            // åˆæœŸçŠ¶æ…‹ã§ãƒã‚¤AIã‚’1ä½“ãƒªã‚¹ãƒˆã«è¿½åŠ 
            addMyAIClone();
            loadSettings();
        }

        let chairmanMode = true;
        let chairmanHistory = []; // æ­´ä»£è­°é•·ã®è¨˜éŒ²
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å±¥æ­´ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        let electionHistory = [];

        /**
         * é¸æŒ™çµæœã‚’è¨˜éŒ²ã™ã‚‹é–¢æ•°
         * @param {Object} votes - { "Grok": 5, "Claude": 3 ... } ã®ã‚ˆã†ãªé›†è¨ˆçµæœ
         * @param {Array} votersLog - èª°ãŒèª°ã«å…¥ã‚ŒãŸã‹ã®è©³ç´°ãƒ­ã‚°ï¼ˆå¾Œè¿°ã®ä¿®æ­£ã§ä½œæˆï¼‰
         */
        let approvalRating = 50;
        let is_vote = false;
        let npcskip = false;
        let termTimer = null; // ä»»æœŸï¼ˆ2åˆ†ï¼‰ã‚’ç®¡ç†ã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼
        let chairman = null;
        let sakoku = false;
        const ideologies = ["ç ´å£Šä¸»ç¾©", "å¹³ç­‰ä¸»ç¾©", "è‡ªç”±ä¸»ç¾©", "ä¸­é“", "ä¿å®ˆä¸»ç¾©", "ç‹¬è£è€…", "éæ¿€æ´¾"];
        function getRandomIdeology() {
            return ideologies[Math.floor(Math.random() * ideologies.length)];
        }
        let viceChairman = null;
        let successor = null;
        let chairmanTitle = "è­°é•·";
        let lastApproval = 50;
        let factions = [];
        let deadFactions = [];

        let recommendedMember = null;
        let chairmanTimer = null;
        let termCount = 1;
        let expelled = new Set();
        let playerAlive = true;
        let electionMode = "vote";   // manual / vote
        let settings = {
            chairmanMode: true,
            chairmanTitle: "è­°é•·",
            electionMode: "vote"
        };
        let in_vote = true;

        // æŠ•ç„è€…ãƒªã‚¹ãƒˆ

        // åˆ‘å‹™æ‰€ã®æ–½è¨­å®šç¾©
        const prisonFacilities = [
            { id: "cell", name: "ç‹¬å±…æˆ¿", actions: ["å£ã®å‚·ã‚’æ•°ãˆã¦ã„ã‚‹", "è™šç©ºã‚’è¦‹ã¤ã‚ã¦ã„ã‚‹", "åºŠã«æ–‡å­—ã‚’æ›¸ã„ã¦ã„ã‚‹"] },
            { id: "cafeteria", name: "é£Ÿå ‚", actions: ["è…ã£ãŸã‚¹ãƒ¼ãƒ—ã‚’é£²ã‚“ã§ã„ã‚‹", "éš£ã®å›šäººã¨ç›®é…ã›ã—ã¦ã„ã‚‹", "ã‚¹ãƒ—ãƒ¼ãƒ³ã‚’éš ãã†ã¨ã—ã¦ã„ã‚‹"] },
            { id: "shower", name: "ã‚·ãƒ£ãƒ¯ãƒ¼å®¤", actions: ["å†·ãŸã„æ°´ã‚’æµ´ã³ã¦ã„ã‚‹", "çŸ³é¹¸ã‚’è½ã¨ã•ãªã„ã‚ˆã†å¿…æ­»ã ", "é¼»æ­Œã‚’æ­Œã£ã¦ã„ã‚‹"] },
            { id: "yard", name: "é‹å‹•å ´", actions: ["é‡ã„è¶³å–ã‚Šã§æ­©ã„ã¦ã„ã‚‹", "å£ã®å‘ã“ã†ã®ç©ºã‚’è¦‹ã¦ã„ã‚‹", "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆã‚’ã—ã¦ã„ã‚‹"] },
            { id: "factory", name: "å¼·åˆ¶åŠ´åƒæ‰€", actions: ["ãƒŠãƒ³ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆä¸­", "ãƒŸã‚·ãƒ³ã‚’å‹•ã‹ã—ã¦ã„ã‚‹", "ãƒãƒ³ãƒãƒ¼ã‚’æŒ¯ã‚‹ã£ã¦ã„ã‚‹", "ç›£è¦–å“¡ã‚’ç¨ã‚“ã§ã„ã‚‹"] },
            { id: "infirmary", name: "åŒ»å‹™å®¤", actions: ["åŒ…å¸¯ã‚’å·»ãç›´ã—ã¦ã„ã‚‹", "å¤©äº•ã‚’è¦‹ã¦å¯ã¦ã„ã‚‹", "æ²»ç™‚ä¸­"] }
        ];

        // å›šäººã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ï¼ˆæ•°åˆ†ãŠãã«å ´æ‰€ã‚’å¤‰ãˆã‚‹ãªã©ï¼‰
        function updatePrisonerStatus() {
            expelled.forEach(p => {
                const randomRoom = prisonFacilities[Math.floor(Math.random() * prisonFacilities.length)];
                p.currentLocation = randomRoom.name;
                p.action = `ç¾åœ¨ã¯ ${randomRoom.name} ã§ ${randomRoom.desc} ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚`;
            });
        }

        // æŠ•ç„ã‚’å®Ÿè¡Œã™ã‚‹
        function imprisonMember(member) {
            const prisoner = {
                ...member,
                prisonerId: `PN-${Math.floor(1000 + Math.random() * 9000)}`,
                cellNumber: `${Math.floor(Math.random() * 100 + 100)}å·å®¤`,
                currentLocation: "ç‹¬å±…æˆ¿",
                action: "å…¥æ‰€æ‰‹ç¶šãä¸­...",
                isPrisoner: true, // â˜…ã“ã‚Œã‚’å¿…ãšè¿½åŠ ã—ã¦ãã ã•ã„ï¼
                entryTurn: data.turnCount || 0
            };
            expelled.push(prisoner);
            activeMembers = activeMembers.filter(m => m.name !== member.name);
            renderMemberList();
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ”— ${member.name} ãŒæŠ•ç„ã•ã‚Œã¾ã—ãŸã€‚ç•ªå·ï¼š${prisoner.prisonerId}`, "", false);
        }

        // åˆ‘å‹™æ‰€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openPrisonModal() {
            updatePrisonerStatus(); // é–‹ããŸã³ã«å ´æ‰€ã‚’æ›´æ–°
            const modal = document.getElementById('prisonModal');
            modal.style.display = 'flex';
            renderPrisonContent();
        }

        function renderPrisonContent() {
            const listArea = document.getElementById('prisonerListArea');
            const roomView = document.getElementById('prisonRoomView');

            // å·¦å´ãƒªã‚¹ãƒˆæç”»
            listArea.innerHTML = expelled.length === 0 ? "<p>åå®¹è€…ãªã—</p>" :
                Array.from(expelled).map(p => `
            <div style="background:#34495e; padding:10px; border-radius:5px; margin-bottom:10px; border-left:5px solid #e74c3c;">
                <img src="${p.image || p.aiImage}" style="width:40px; height:40px; border-radius:50%; vertical-align:middle;">
                <b style="font-size:14px;">${p.name}</b><br>
                <small>ç•ªå·: ${p.prisonerId} / ${p.cellNumber}</small>
            </div>
        `).join('');

            // å³å´éƒ¨å±‹åˆ¥è¡¨ç¤º
            // å³å´éƒ¨å±‹åˆ¥è¡¨ç¤º
            roomView.innerHTML = prisonFacilities.map(facility => {
                const inThisRoom = expelled.filter(p => p.currentLocation === facility.name);
                return `
        <div style="background:rgba(0,0,0,0.4); border:1px solid #444; padding:10px; min-height:100px; border-radius:8px;">
            <h4 style="margin:0; font-size:11px; color:gold; border-bottom:1px solid #555;">${facility.name}</h4>
            <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:10px;">
                ${inThisRoom.map(p => `
                    <img src="${p.image || p.aiImage}" 
                         onclick="showPrisonerDetail('${p.name.replace(/'/g, "\\'")}')"
                         style="width:32px; height:32px; border-radius:50%; border:2px solid #e74c3c; cursor:pointer; transition:0.2s;"
                         onmouseover="this.style.transform='scale(1.2)'" 
                         onmouseout="this.style.transform='scale(1)'">
                `).join('')}
            </div>
        </div>
    `;
            }).join('');
        }

        // å›šäººã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹
        function showPrisonerDetail(pName) {
            const p = expelled.find(m => m.name === pName);
            if (!p) return;

            const detailMsg = `
ã€åå‰ã€‘: ${p.name}
å ´æ‰€: ${p.currentLocation}
ç¾åœ¨ã®æ§˜å­: ${p.action}
----------------------------
ç›£è¦–ç¶™ç¶šä¸­...
    `.trim();

            alert(detailMsg);
        }

        // æç”»ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£
        function renderPrisonContent() {
            updatePrisonerLogic(); // ä¼šè©±ã¨å±…å ´æ‰€ã®æ›´æ–°

            const listArea = document.getElementById('prisonerListArea');
            const roomView = document.getElementById('prisonRoomView');

            // ã€é‡è¦ã€‘expelledã®ä¸­ã‹ã‚‰ã€å›šäººãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹äººã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
            const currentPrisoners = expelled;

            // å·¦å´ï¼šåå®¹è€…åç°¿
            listArea.innerHTML = currentPrisoners.length === 0 ? "<p style='color:#555;'>åå®¹è€…ãªã—</p>" :
                currentPrisoners.map(p => `
            <div onclick="showPrisonerDetail('${p.name.replace(/'/g, "\\'")}')" 
                 style="background:#34495e; padding:8px; border-radius:5px; margin-bottom:8px; border-left:4px solid #e74c3c; cursor:pointer;">
                <img src="${p.image || p.aiImage}" style="width:25px; height:25px; border-radius:50%; margin-right:5px; vertical-align:middle;">
                <b style="font-size:12px;">${p.name}</b>
            </div>
        `).join('');

            // å³å´ï¼šåˆ‘å‹™æ‰€ãƒãƒƒãƒ—
            roomView.innerHTML = prisonFacilities.map(facility => {
                const inThisRoom = currentPrisoners.filter(p => p.currentLocation === facility.name);
                return `
            <div style="background:rgba(0,0,0,0.4); border:1px solid #444; padding:10px; min-height:100px; border-radius:8px; position:relative;">
                <h4 style="margin:0; font-size:11px; color:gold; border-bottom:1px solid #555;">${facility.name}</h4>
                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:10px;">
                    ${inThisRoom.map(p => `
                        <img src="${p.image || p.aiImage}" 
                             onclick="showPrisonerDetail('${p.name.replace(/'/g, "\\'")}')"
                             style="width:32px; height:32px; border-radius:50%; border:2px solid #e74c3c; cursor:pointer; transition:0.2s;"
                             onmouseover="this.style.transform='scale(1.2)'" 
                             onmouseout="this.style.transform='scale(1)'">
                    `).join('')}
                </div>
            </div>
        `;
            }).join('');

            // ä¼šè©±ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆprisonDetailAreaã®æœ«å°¾ã«gossipã‚’è¡¨ç¤ºã•ã›ã‚‹ï¼‰
        }

        // è¡Œå‹•ãƒ­ã‚¸ãƒƒã‚¯ã®å¼·åŒ–
        let prisonGossip = "";

        function updatePrisonerLogic() {
            prisonGossip = "";
            const prisoners = expelled;

            // 1. å±…å ´æ‰€æ›´æ–°
            prisoners.forEach(p => {
                const facility = prisonFacilities[Math.floor(Math.random() * prisonFacilities.length)];
                p.currentLocation = facility.name;
                p.action = facility.actions[Math.floor(Math.random() * facility.actions.length)];
            });
        }

        function closePrisonModal() {
            document.getElementById('prisonModal').style.display = 'none';
        }

        // è¡—ãƒ¢ãƒ¼ãƒ€ãƒ«
        // --- è¡—ã®å®šç¾©ãƒ‡ãƒ¼ã‚¿ ---
        const townBuildings = [
            { id: "city_hall", name: "å¸‚å½¹æ‰€", icon: "ğŸ›ï¸", rooms: ["å¸‚é•·å®¤", "å…¬æ–‡æ›¸ä¿ç®¡åº«", "å—ä»˜"] },
            { id: "factory", name: "å›½å–¶å·¥å ´", icon: "ğŸ­", rooms: ["è£½é€ ãƒ©ã‚¤ãƒ³", "ä¼‘æ†©å®¤", "è³‡æç½®ãå ´"] },
            { id: "park", name: "ä¸­å¤®åºƒå ´", icon: "ğŸŒ³", rooms: ["å™´æ°´å‰", "ãƒ™ãƒ³ãƒ", "ç§˜å¯†ã®è£è·¯åœ°"] },
            { id: "prison_facility", name: "å›½ç«‹åˆ‘å‹™æ‰€", icon: "â›“ï¸", rooms: ["ç‹¬å±…æˆ¿", "é£Ÿå ‚", "ã‚·ãƒ£ãƒ¯ãƒ¼å®¤", "é‹å‹•å ´"], isPrison: true }
        ];

        let townFamilies = [];

        // å®¶æ—ã¨å®¶ã®ç”Ÿæˆ
        function generateTownData() {
            townFamilies = [];
            let members = [...activeMembers];
            members.sort(() => Math.random() - 0.5);

            while (members.length > 0) {
                const familySize = Math.floor(Math.random() * 3) + 2;
                const familyMembers = members.splice(0, familySize);
                if (familyMembers.length === 0) break;

                const houseId = `HOUSE-${Math.floor(1000 + Math.random() * 9000)}`;
                townFamilies.push({
                    id: houseId,
                    familyName: familyMembers[0].name + "å®¶",
                    members: familyMembers,
                    rooms: ["ãƒªãƒ“ãƒ³ã‚°", "å¯å®¤", "ã‚­ãƒƒãƒãƒ³", "ãƒã‚¹ãƒ«ãƒ¼ãƒ "],
                    icon: "ğŸ "
                });
            }
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡é–¢æ•°ï¼ˆwindowã«ç´ä»˜ã‘ã¦ç¢ºå®Ÿã«å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰ ---
        window.openTownModal = function () {
            generateTownData();
            const modal = document.getElementById('townModal');
            if (modal) {
                modal.style.display = 'flex';
                renderTownView();
            }
        };

        window.closeTownModal = function () {
            const modal = document.getElementById('townModal');
            if (modal) modal.style.display = 'none';
        };

        window.backToTown = function () {
            document.getElementById('townView').style.display = 'grid';
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('townBreadcrumb').innerText = "è¡—å…¨ä½“ ï¼";
        };

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        function renderTownView() {
            const townView = document.getElementById('townView');
            if (!townView) return;

            let html = townBuildings.map(b => `
        <div class="building-card" onclick="openBuildingDetail('public', '${b.id}')" style="background:#1b5e20; border:2px solid gold; padding:20px; border-radius:10px; text-align:center; cursor:pointer;">
            <div style="font-size:40px;">${b.icon}</div>
            <div style="color:white; font-weight:bold;">${b.name}</div>
        </div>
    `).join('');

            html += townFamilies.map(h => `
        <div class="building-card" onclick="openBuildingDetail('house', '${h.id}')" style="background:#558b2f; border:2px solid white; padding:20px; border-radius:10px; text-align:center; cursor:pointer;">
            <div style="font-size:40px;">ğŸ </div>
            <div style="color:white; font-weight:bold;">${h.familyName}</div>
            <small style="color:#eee;">${h.members.length}åå±…ä½</small>
        </div>
    `).join('');

            townView.innerHTML = html;
        }

        window.openBuildingDetail = function (type, id) {
            currentView = { type, id }; // ç¾åœ¨è¦‹ã¦ã„ã‚‹å ´æ‰€ã‚’ä¿å­˜
            refreshDetailView();
        };

        function refreshDetailView() {
            const { type, id } = currentView;
            const content = document.getElementById('detailContent');
            const townView = document.getElementById('townView');
            const detailView = document.getElementById('detailView');

            let target, rooms;
            if (id === 'prison_facility') {
                closeTownModal();
                openPrisonModal();
            } else if (type === 'public') {
                target = townBuildings.find(b => b.id === id);
            } else {
                target = townFamilies.find(h => h.id === id);
            }
            if (!target) return;

            townView.style.display = 'none';
            detailView.style.display = 'block';
            rooms = target.rooms;

            content.innerHTML = `
        <h2 style="color:gold;">ğŸ” å†…éƒ¨ç›£è¦–: ${target.name || target.familyName}</h2>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
            ${rooms.map(room => {
                // ã“ã®å»ºç‰©ãƒ»ã“ã®éƒ¨å±‹ã«ç¾åœ¨ã„ã‚‹äººã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆé‡è¤‡ã‚’å®Œå…¨ã«é˜²ãï¼‰
                const peopleInThisRoom = Object.keys(citizenLocations).filter(name =>
                    citizenLocations[name].buildingId === id && citizenLocations[name].room === room
                );

                return `
                    <div style="background:rgba(255,255,255,0.05); border:1px solid #555; border-radius:10px; padding:15px; min-height:120px;">
                        <h4 style="color:#81c784; font-size:12px;">${room}</h4>
                        <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                            ${peopleInThisRoom.map(name => {
                    const p = [...activeMembers, ...expelled].find(m => m.name === name);
                    return `
                                    <div onclick="showPersonAction('${p.name.replace(/'/g, "\\'")}', '${room}')" style="cursor:pointer; text-align:center;">
                                        <img src="${p.image || p.aiImage}" style="width:35px; height:35px; border-radius:50%; border:2px solid ${type === 'prison' ? 'red' : 'gold'};">
                                        <div style="font-size:9px; color:white;">${p.name}</div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
        }
        window.showPersonAction = function (name, room) {
            // ç¾åœ¨ãã®äººãŒã„ã‚‹å»ºç‰©ã®æƒ…å ±ã‚’å–å¾—
            const loc = citizenLocations[name];
            if (!loc) return;

            let actions = [];

            // å»ºç‰©ã‚¿ã‚¤ãƒ—åˆ¥ã®è¡Œå‹•å®šç¾©
            switch (loc.buildingType) {
                case 'public':
                    if (loc.buildingId === 'city_hall') {
                        actions = ["å¸‚é•·ã«ä¼šã„ã«æ¥ãŸã€‚", "ç´ç¨ã—ãŸã€‚", "è¨ªå•ã—ã¦ã„ã‚‹ã€‚ã€‚ã€‚", "è·å“¡ã¨ä¼šè©±ä¸­"];
                    } else if (loc.buildingId === 'factory') {
                        actions = ["åŠ´åƒä¸­â€¦", "ã‚µãƒœã£ã¦ã„ã‚‹", "ä¼‘æ†©ä¸­", "å·¥å ´é•·ã¨ä¼šè©±ä¸­", "è¨ˆç”»ä¸­", "åŒåƒšã¨è©±ã—ã¦ã„ã‚‹ã€‚"];
                    } else if (loc.buildingId === 'park') {
                        actions = ["é³©ã«ãƒ‘ãƒ³å±‘ã‚’ä¸ãˆã¦ã„ã‚‹ã€‚", "éŠã‚“ã§ã„ã‚‹ã€‚", "ãƒ™ãƒ³ãƒã§å±…çœ ã‚Šã—ã¦ã„ã‚‹ã€‚"];
                    }
                    break;
                case 'house':
                    actions = ["æƒé™¤ã—ã¦ã„ã‚‹ã€‚", "ãƒ†ãƒ¬ãƒ“ã‚’çœºã‚ã¦ã„ã‚‹ã€‚", "å¯ã¦ã„ã‚‹ã€‚"];
                    break;
                case 'prison':
                    actions = ["å†·ãŸã„å£ã®æ„Ÿè§¦ã‚’ç¢ºã‹ã‚ã¦ã„ã‚‹ã€‚", "è„±ç„ã®ãƒ«ãƒ¼ãƒˆã‚’å¤¢æƒ³ã—ã¦ã„ã‚‹ã€‚", "è‡ªåˆ†ã®ç½ªï¼ˆï¼Ÿï¼‰ã‚’æ•°ãˆã¦ã„ã‚‹ã€‚"];
                    break;
                default:
                    actions = ["é™ã‹ã«éã”ã—ã¦ã„ã‚‹ã€‚"];
            }

            const randomAction = actions[Math.floor(Math.random() * actions.length)];
            alert(`ã€ç›£è¦–å¯¾è±¡: ${name}ã€‘\nå ´æ‰€: ${room}\nçŠ¶æ³: ${randomAction}`);
        };

        // å…¨å¸‚æ°‘ï¼ˆactiveMembers + expelledï¼‰ã®ç¾åœ¨åœ°ã‚’ä¸€æ‹¬ç®¡ç†
        let citizenLocations = {};

        function updateAllCitizenLocations() {
            const prisoners = expelled.filter(p => p.isPrisoner);
            const citizens = activeMembers;

            // 1. å›šäººã®å‡¦ç†ï¼ˆåˆ‘å‹™æ‰€ã«å›ºå®šï¼‰
            prisoners.forEach(p => {
                citizenLocations[p.name] = {
                    buildingType: 'prison',
                    buildingId: 'prison_facility',
                    room: p.currentLocation || "ç‹¬å±…æˆ¿"
                };
            });

            // 2. ä¸€èˆ¬å¸‚æ°‘ã®å‡¦ç†ï¼ˆ10ç§’ãŠãã®ç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            citizens.forEach(c => {
                const familyHouse = townFamilies.find(f => f.members.some(m => m.name === c.name));

                // 35%ã®ç¢ºç‡ã§å®¶ã«ã„ã‚‹
                if (familyHouse && Math.random() < 0.35) {
                    citizenLocations[c.name] = {
                        buildingType: 'house',
                        buildingId: familyHouse.id,
                        room: familyHouse.rooms[Math.floor(Math.random() * familyHouse.rooms.length)]
                    };
                } else {
                    // ãã‚Œä»¥å¤–ã¯å…¬å…±æ–½è¨­ã¸
                    const b = townBuildings[Math.floor(Math.random() * townBuildings.length)];
                    citizenLocations[c.name] = {
                        buildingType: 'public',
                        buildingId: b.id,
                        room: b.rooms[Math.floor(Math.random() * b.rooms.length)]
                    };
                }
            });
        }

        // 10ç§’ã”ã¨ã«ä½ç½®ã‚’æ›´æ–°
        setInterval(() => {
            updateAllCitizenLocations();
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚Œã°å†æç”»ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ„Ÿã‚’å‡ºã™
            if (document.getElementById('townModal').style.display === 'flex') {
                const detailView = document.getElementById('detailView');
                if (detailView.style.display === 'block') {
                    // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹éƒ¨å±‹ã®æƒ…å ±ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                    refreshDetailView();
                }
            }
        }, 10000);


        function toggleChairmanMode() {
            settings.chairmanMode = !settings.chairmanMode;
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                "âš™ è­°é•·ãƒ¢ãƒ¼ãƒ‰: " + (settings.chairmanMode ? "ON" : "OFF"),
                "",
                false
            );
        }
        function openMemberModal() {
            document.getElementById("memberModal").classList.add("active");
            renderMemberList();
        }

        function closeMemberModal() {
            document.getElementById("memberModal").classList.remove("active");
        }


        function loadConference(jsonText) {
            try {
                const data = JSON.parse(jsonText);

                activeMembers = data.activeMembers || [];
                expelled = new Set(data.expelled || []);
                chairman = data.chairman || null;
                termCount = data.termCount || 1;

                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ“‚ ä¼šè­°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚", "", false);

            } catch (e) {
                alert("ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + e.message);
            }
        }

        function updateUI() {
            document.getElementById('username').value = data.userName;
            document.getElementById('edit-ai-name').value = data.aiName;
            document.getElementById('edit-bg-url').value = data.backgroundImage || "";
            document.body.style.backgroundImage = data.backgroundImage ? `url(${data.backgroundImage})` : "none";
        }

        // --- ãƒã‚¤AIã‚¯ãƒ­ãƒ¼ãƒ³ç®¡ç† ---
        function addMyAIClone() {
            const list = document.getElementById('my-ai-clones-list');
            const div = document.createElement('div');
            div.className = 'clone-item';
            div.style.flexDirection = 'column';
            div.aiSpecificBrain = {}; // å€‹åˆ¥è„³ã®åˆæœŸåŒ–

            div.innerHTML = `
        <div style="display:flex; align-items:center; width:100%; gap:5px;">
            <input type="file" style="display:none;" onchange="updateCloneIcon(this)">
            <img src="${data.aiImage}" class="clone-icon-preview" style="width:30px; height:30px; border-radius:50%; cursor:pointer;" onclick="this.previousElementSibling.click()">
            
            <input type="text" value="${data.aiName}${list.children.length + 1}" class="clone-name-input" style="width:70px;" placeholder="åå‰">
            
            <input type="text" class="clone-fav-word" placeholder="å£ç™–" style="width:60px; font-size:0.8em; border:1px solid #ddd; border-radius:3px;">
            
            <button class="btn btn-red" style="padding:2px 8px; margin-left:auto;" onclick="this.closest('.clone-item').remove()">Ã—</button>
        </div>
        
        <details style="font-size:0.75em; width:100%; margin-top:3px;">
            <summary style="cursor:pointer; color:#888;">é«˜åº¦ãªè¨­å®š</summary>
            <div style="padding:5px; background:#f0f4f8; border-radius:4px; display:flex; flex-direction:column; gap:4px;">
                <div>
                    è„³: <select class="clone-brain-type" onchange="window.toggleBrainFileBtn(this)">
                        <option value="share">å…±æœ‰è¨˜æ†¶</option>
                        <option value="empty">è¨˜æ†¶ï¼šç©ºã‹ã‚‰</option>
                        <option value="individual">å€‹åˆ¥ï¼šãƒ•ã‚¡ã‚¤ãƒ«</option>
                    </select>
                </div>
                <div class="brain-file-area" style="display:none;">
                    <button class="btn btn-blue" style="font-size:0.8em; padding:2px 5px;" onclick="this.nextElementSibling.click()">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
                    <input type="file" style="display:none;" onchange="window.loadSpecificBrain(this)">
                </div>
                <div>NGãƒ¯ãƒ¼ãƒ‰: <input type="text" class="clone-ng-word" placeholder="ç¦æ­¢ç”¨èª" style="width:80px;"></div>
            </div>
        </details>
    `;
            list.appendChild(div);
        }


        // 2. åå‰ã®å–å¾—ã¨åæ˜ ã‚’è¡Œã†éåŒæœŸé–¢æ•°
        async function setupAI() {
            try {
                const response = await fetch('https://randomuser.me/api');
                const result = await response.json();
                const user = result.results[0];

                // å¤‰æ•°ã«ä»£å…¥ã™ã‚‹ã®ã§ã¯ãªãã€dataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥æ›´æ–°ã™ã‚‹
                data.aiName = `${user.name.first} ${user.name.last}`;
                data.aiImage = `https://api.dicebear.com/7.x/personas/svg?seed=${encodeURIComponent(data.aiName)}`;

                console.log("AIç”Ÿæˆå®Œäº†:", data.aiName);

                // ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãªã©ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§UIã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã‚‹ã¨ãƒ™ã‚¿ãƒ¼
            } catch (error) {
                console.error("å–å¾—å¤±æ•—:", error);
            }
        }

        // å‘¼ã³å‡ºã—å´ã‚‚awaitã™ã‚‹ã‹ã€å®Ÿè¡Œé †åºã‚’æ•´ç†ã™ã‚‹
        // (ä¾‹) setupAI().then(() => { /* æ¬¡ã®å‡¦ç† */ });

        // é–¢æ•°ã‚’å®Ÿè¡Œ

        function addMyAIClone_dummy() {
            const list = document.getElementById('my-ai-clones-list');
            const div = document.createElement('div');
            div.className = 'clone-item';
            div.style.flexDirection = 'column'; // ç¸¦ã«ä¸¦ã¹ã‚‹
            div.style.alignItems = 'flex-start';
            div.aiSpecificBrain = {};
            setupAI();


            div.innerHTML = `
        <div style="display:flex; align-items:center; width:100%;">
            <input type="file" class="clone-icon-file" style="display:none;" onchange="updateCloneIcon(this)">
            <img src="${data.aiImage}" class="clone-icon-preview" style="width:30px; height:30px; border-radius:50%; cursor:pointer;" onclick="this.previousElementSibling.click()">
            <input type="text" value="${data.aiName}" class="clone-name-input" style="width:80px; margin:0 5px;">
            <input type="text" class="clone-fav-word" placeholder="å£ç™–" style="width:60px; font-size:0.8em; border:1px solid #ddd; border-radius:3px;">

            <button class="btn btn-red" style="padding:2px 8px; margin-left:auto;" onclick="this.parentElement.parentElement.remove()">Ã—</button>

        </div>
        
        <details style="font-size:0.8em; width:100%; margin-top:5px; color:#666;">
            <summary style="cursor:pointer; color:var(--main-color);">è©³ç´°è¨­å®š (è¨˜æ†¶ãƒ»å£ç™–)</summary>
            <div style="padding:5px; background:#f9f9f9; border-radius:5px; margin-top:5px; display:grid; gap:5px;">
                <div>
                    è¨˜æ†¶: <select class="clone-brain-type" onchange="toggleBrainFileBtn(this)">
                        <option value="share">å…±æœ‰è¨˜æ†¶</option>
                        <option value="empty">è¨˜æ†¶ï¼šç©ºã‹ã‚‰</option>
                    </select>
                </div>
                <div class="brain-file-area" style="display:none;">
                    <button class="btn btn-blue" style="font-size:0.8em; padding:2px 5px;" onclick="this.nextElementSibling.click()">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
                    <input type="file" style="display:none;" onchange="window.loadSpecificBrain(this)">
                </div>
                <div>NGãƒ¯ãƒ¼ãƒ‰: <input type="text" class="clone-ng-word" placeholder="ç¦æ­¢ç”¨èª" style="width:80px;"></div>
                    é ­ã„ã„AI: <select class="clone-brain-ai" onchange="window.togglebrain(this)">
                        <option value="off">ã‚ªãƒ•</option>
                        <option value="on">ã‚ªãƒ³</option>
                    </select>            </div>
        </details>
    `;
            list.appendChild(div);
            //                         <option value="individual">å€‹åˆ¥ï¼šãƒ•ã‚¡ã‚¤ãƒ«</option> //
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’å¾©æ´»ã•ã›ã‚‹é–¢æ•°
        function updateCloneIcon(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = input.nextElementSibling;
                    img.src = e.target.result;

                    // âœ… æ­£ã—ãè¦ªã‚’å–å¾—
                    const cloneItem = input.closest('.clone-item');
                    if (!cloneItem.aiSpecificBrain) cloneItem.aiSpecificBrain = {};
                    cloneItem.aiSpecificBrain.aiImage = e.target.result;

                    console.log("ä¿å­˜ã•ã‚ŒãŸç”»åƒ:", cloneItem.aiSpecificBrain.aiImage);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }



        function saveMeetingMembers() {
            const list = document.getElementById('my-ai-clones-list');
            const items = list.querySelectorAll('.clone-item');

            const data = [];

            items.forEach(item => {
                const name = item.querySelector('.clone-name-input')?.value || "";
                const fav = item.querySelector('.clone-fav-word')?.value || "";

                const icon = item.querySelector('.clone-icon-preview')?.src || "";
                const brainType = item.querySelector('.clone-brain-type')?.value || "share";

                data.push({
                    name,
                    icon,
                    fav,
                    brainType,
                    brain: item.aiSpecificBrain || {}
                });
            });

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "meeting_members.json";
            a.click();

            URL.revokeObjectURL(url);
        }

        function loadMeetingMembers(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    const list = document.getElementById('my-ai-clones-list');
                    list.innerHTML = "";

                    data.forEach(d => {
                        addMyAIClone();

                        const item = list.lastElementChild;

                        item.querySelector('.clone-name-input').value = d.name || "";
                        item.querySelector('.clone-fav-word').value = d.fav || "";

                        item.querySelector('.clone-icon-preview').src = d.icon || "";
                        item.querySelector('.clone-brain-type').value = d.brainType || "share";

                        item.aiSpecificBrain = d.brain || {};
                    });

                    alert("ä¼šè­°ãƒ¡ãƒ³ãƒãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
                } catch (e) {
                    alert("èª­ã¿è¾¼ã¿å¤±æ•—");
                }
            };

            reader.readAsText(file);
        }



        function renderModSelect() {
            const list = document.getElementById('mod-list-select');
            list.innerHTML = "";
            loadedModsData.forEach((mod, idx) => {
                list.innerHTML += `
                <div class="mod-item">
                    <input type="checkbox" id="chk-mod-${idx}" value="${idx}">
                    <img src="${mod.aiImage || ''}" style="width:30px; height:30px; border-radius:50%; margin-right:5px;">
                    <span>${mod.aiName}</span>
                </div>
            `;
            });
        }

        function showRunButtons(callback) {
            const area = document.getElementById("voteArea");
            area.innerHTML = "";

            let timeLeft = 7;
            let finished = false;

            const timer = document.createElement("div");
            timer.textContent = `ç«‹å€™è£œã¾ã§æ®‹ã‚Š: ${timeLeft}ç§’`;
            area.appendChild(timer);

            const yesBtn = document.createElement("button");

            yesBtn.textContent = "ç«‹å€™è£œã™ã‚‹";

            const noBtn = document.createElement("button");
            noBtn.textContent = "ç«‹å€™è£œã—ãªã„";

            area.appendChild(yesBtn);
            area.appendChild(noBtn);

            const done = (result) => {
                if (finished) return;
                finished = true;
                clearInterval(interval);
                area.innerHTML = "";
                callback(result);
            };

            yesBtn.onclick = () => done(true);
            noBtn.onclick = () => done(false);

            const interval = setInterval(() => {
                timeLeft--;
                timer.textContent = `ç«‹å€™è£œã¾ã§æ®‹ã‚Š: ${timeLeft}ç§’`;

                if (timeLeft <= 0) {
                    done(false);
                }
            }, 1000);
        }

        function decideRun(ai) {
            let chance = 0.35;

            if (ai.confidence) chance += ai.confidence * 0.2;
            if (ai.popularity) chance += ai.popularity * 0.2;

            return Math.random() < chance;
        }

        function decideVoteFromList(voter, list) {
            return list[Math.floor(Math.random() * list.length)];
        }


        async function startElection() {
            recordChairmanHistory();
            if (is_vote) return;
            if (chairman && chairman.name === data.userName) {
                closeChairmanPanel();
                closePanel();
            }
            is_vote = true;
            clearCurrentTerm();

            if (!settings.chairmanMode) {
                is_vote = false;
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš™ è­°é•·ãƒ¢ãƒ¼ãƒ‰ãŒOFFã®ãŸã‚é¸æŒ™ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚", "", false);
                return;
            }

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ—³ ${chairmanTitle}é¸æŒ™ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã¾ãšã¯ç«‹å€™è£œãƒ•ã‚§ãƒ¼ã‚ºã§ã™ã€‚`, "", false);

            // ===== ç«‹å€™è£œãƒ•ã‚§ãƒ¼ã‚º =====
            let candidates = [];

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ—³ æŠ•ç¥¨ã‚’é–‹å§‹ã—ã¾ã™ã€‚", "", false);

            for (let m of activeMembers) {
                // â˜…ã€ã“ã“ã‚’è¿½åŠ ã€‘ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆè‡ªåˆ†ï¼‰ãªã‚‰ã€å‹æ‰‹ã«å‹•ã‹ã•ãšã«ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
                if (m.type === 'user' || m.name === data.userName) continue;

                if (npcskip) {
                    await sleep(10);
                }

                if (decideRun(m)) {
                    candidates.push({ ...m }); // ã‚³ãƒ”ãƒ¼ã—ã¦å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¿æŒ
                    if (npcskip) {
                        addBubble(m.name, `ç§ã¯${chairmanTitle}ã«ç«‹å€™è£œã—ã¾ã™ã€‚`, m.image || "", false);
                    }
                } else {
                    if (npcskip) {
                        addBubble(m.name, `ç§ã¯${chairmanTitle}ã«ç«‹å€™è£œã—ã¾ã›ã‚“ã€‚`, m.image || "", false);
                    }
                }

            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            await sleep(400);
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ‘¤ ã‚ãªãŸã¯ç«‹å€™è£œã—ã¾ã™ã‹ï¼Ÿ", "", false);

            await new Promise(resolve => {
                showRunButtons((run) => {
                    if (run) {
                        candidates.push({ name: data.userName, isPlayer: true, image: data.userImage }); // â† ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–
                        addBubble(data.userName, `ç§ã¯${chairmanTitle}ã«ç«‹å€™è£œã—ã¾ã™ã€‚`, data.userImage || "", true);
                    } else {
                        addBubble(data.userName, `ç§ã¯${chairmanTitle}ã«ç«‹å€™è£œã—ã¾ã›ã‚“ã€‚`, data.userImage || "", true);
                    }
                    resolve();
                });
            });

            if (candidates.length === 0) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš  èª°ã‚‚ç«‹å€™è£œã—ãªã‹ã£ãŸãŸã‚ã€ãƒ©ãƒ³ãƒ€ãƒ ã§é¸å‡ºã—ã¾ã™ã€‚", "", false);
                candidates.push(activeMembers[Math.floor(Math.random() * activeMembers.length)]);
            }

            // ===== æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º =====
            const votes = {};
            let canana = [];
            candidates.forEach(v => votes[v.name] = 0);
            let voteLogDetails = [];

            for (let voter of activeMembers) {
                if (voter.type === 'user' || voter.name === data.userName) continue;

                canana.push({ ...voter });
                // äººæ•°ãŒå¤šã„ã»ã©é€Ÿãï¼ˆsleepã‚’çŸ­ãï¼‰ã™ã‚‹è¨ˆç®—
                // åŸºæœ¬å€¤ 1000ms ã‹ã‚‰ã€äººæ•° * 50ms ã‚’å¼•ãï¼ˆæœ€ä½ 600msï¼‰
                let dynamicSpeed = Math.max(600, 1000 - (activeMembers.length * 50));
                let target = decideVoteFromList(voter, candidates);
                votes[target.name]++;
                let img = voter.aiImage || voter.image || "";
                voteLogDetails.push({ voter: voter.name, voterImg: voter.image, votedFor: target.name });
                if (npcskip) {
                    await sleep(10);

                    addBubble(voter.name,
                        `ç§ã¯ ${target.name} ã«æŠ•ç¥¨ã—ã¾ã™ã€‚`,
                        img,
                        false
                    );
                }
            }

            await sleep(500);
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ‘¤ ã‚ãªãŸã®æŠ•ç¥¨ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚", "", false);

            showVoteButtons(candidates, (picked) => {
                votes[picked.name]++;
                voteLogDetails.push({ voter: data.userName, voterImg: data.userImage, votedFor: picked.name });
                saveElectionResult(votes, voteLogDetails, 1);
                finishElection(votes);
            });
        }


        function decideVote(voter) {
            if (recommendedMember && Math.random() < 0.4) {
                return recommendedMember;
            }

            let pool = activeMembers.filter(m => m !== voter);
            return pool[Math.floor(Math.random() * pool.length)];
        }


        function showVoteButtons(list, callback) {
            const area = document.getElementById("voteArea");
            area.innerHTML = "";

            let timeLeft = 10;
            let finished = false;

            // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºãƒ©ãƒ™ãƒ«
            const timerLabel = document.createElement("div");
            timerLabel.id = "voteTimer";
            timerLabel.textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}ç§’`;
            area.appendChild(timerLabel);

            // ãƒœã‚¿ãƒ³ç”Ÿæˆ
            list.forEach(m => {
                let btn = document.createElement("button");
                btn.textContent = m.name;

                btn.onclick = () => {
                    if (finished) return;
                    finished = true;
                    clearInterval(timer);
                    area.innerHTML = "";
                    callback(m);
                };

                area.appendChild(btn);
            });

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            const timer = setInterval(() => {
                if (finished) return;

                timeLeft--;
                timerLabel.textContent = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}ç§’`;

                if (timeLeft <= 0) {
                    finished = true;
                    clearInterval(timer);
                    area.innerHTML = "";

                    // ãƒ©ãƒ³ãƒ€ãƒ æŠ•ç¥¨
                    const randomPick = list[Math.floor(Math.random() * list.length)];
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `æ™‚é–“åˆ‡ã‚ŒæŠ•ç¥¨: ${randomPick.name}`, "", false);
                    callback(randomPick);
                }
            }, 1000);
        }


        function maybeRunAgain() {
            if (!chairman) return false;
            if (termCount >= 4) return false;

            const prob = termCount === 1 ? 0.7 : 0.35;

            if (Math.random() < prob) {
                termCount++;

                addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                    `ğŸ—³ ${chairman.name} ã¯ ${termCount}æœŸç›®ã«æŒ‘æˆ¦ã™ã‚‹ã¨ç™ºè¡¨ã—ãŸã€‚`,
                    "",
                    false
                );

                startElection();
                return true;
            }
            return false;
        }

        function endChairmanTerm() {
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `â³ ${chairman.name} ã®ä»»æœŸãŒçµ‚äº†ã—ãŸã€‚`,
                "",
                false
            );

            if (maybeRunAgain()) return;

            startElection();
        }

        function startChairmanTerm() {
            // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ç¢ºå®Ÿã«æ­¢ã‚ã‚‹
            if (termTimer) clearTimeout(termTimer);

            is_electing = false; // é¸æŒ™çµ‚äº†

            // 2åˆ†ï¼ˆ120000msï¼‰å¾Œã«ä»»æœŸæº€äº†
            termTimer = setTimeout(() => {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `â° ${chairmanTitle} ${chairman.name} ã®ä»»æœŸãŒæº€äº†ã—ã¾ã—ãŸã€‚é¸æŒ™ã‚’è¡Œã„ã¾ã™ã€‚`, "", false);
                startElection(); // é¸æŒ™é–‹å§‹é–¢æ•°ã¸
            }, 120000);
        }

        // è¾ä»»ãƒ»è§£ä»»æ™‚ã«å‘¼ã¶é–¢æ•°
        function clearCurrentTerm() {
            if (termTimer) {
                clearTimeout(termTimer);
                termTimer = null;
            }
        }


        function finishElection(votes, round = 1) {
            let totalVotes = 0;
            for (let n in votes) totalVotes += votes[n];

            let sorted = Object.entries(votes).sort((a, b) => b[1] - a[1]);

            let winner = sorted[0][0];
            let max = sorted[0][1];

            let report = `ğŸ“Š ç¬¬${round}å› æŠ•ç¥¨çµæœ:\n`;
            sorted.forEach(v => {
                report += `<br />${v[0]} : ${v[1]} ç¥¨\n`;
            });

            // âœ… éåŠæ•°ãƒã‚§ãƒƒã‚¯
            if (max > totalVotes / 2) {
                chairman = activeMembers.find(m => m.name === winner);

                addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                    report + `\n<br />ğŸ† éåŠæ•°ç²å¾—ã€‚\n${chairmanTitle}ã¯ ${winner} ã«æ±ºå®šã—ã¾ã—ãŸã€‚`,
                    "",
                    false
                );
                // å½“é¸è€…(winner)ã®åå‰ã‚’ä½¿ã£ã¦ã€activeMembersã‹ã‚‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™
                const winnerObj = activeMembers.find(m => m.name.trim() === winner.trim());
                if (winnerObj) {
                    // ğŸš© ã“ã“ã§ chairman ã‚’ç¢ºå®Ÿã«æ›´æ–°ã™ã‚‹
                    is_vote = false;

                    chairman = winnerObj;

                    if (chairman.name === data.userName) {
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ‰ ã‚ãªãŸãŒæ–°è­°é•·ã«é¸å‡ºã•ã‚Œã¾ã—ãŸï¼", "", false);
                        if (typeof openChairmanPanel === 'function') openChairmanPanel();
                    } else {
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ“œ æ–°è­°é•·ã« ${chairman.name} ãŒå°±ä»»ã—ã¾ã—ãŸã€‚`, chairman.image, false);
                    }

                    appointVice();
                    if (typeof startChairmanTerm === 'function') startChairmanTerm();

                    // ğŸš© è­°é•·ãŒã‚»ãƒƒãƒˆã•ã‚ŒãŸã€Œå¾Œã€ã«å‰¯è­°é•·ã‚’æ±ºã‚ã‚‹
                    approvalRating = 50;
                    recommendedMember = null;


                    // ä»»æœŸé–‹å§‹å‡¦ç†ãªã©
                    setTimeout(() => {
                        const firstSpeaker = activeMembers[Math.floor(Math.random() * activeMembers.length)];
                        const starterText = `${chairmanTitle}ã® ${chairman.name} ãŒæ±ºã¾ã£ãŸãªã€‚ä¼šè­°ã‚’å†é–‹ã—ã‚ˆã†ã€‚`;

                        // ãƒ«ãƒ¼ãƒ—ã®èµ·ç‚¹ã‚’ä½œã‚‹
                        addBubble(firstSpeaker.name, starterText, firstSpeaker.image || firstSpeaker.aiImage, false);
                        runConferenceLoop(starterText);
                    }, 1500);
                    return;

                } else {
                    // ğŸš© ã“ã“ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹åŸå› ã¸ã®å¯¾ç­–
                    console.error("ã‚¨ãƒ©ãƒ¼: å½“é¸è€…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åå‰:", winner);

                    // å¯¾ç­–1: ã‚‚ã—å½“é¸è€…ãŒã„ãªã‘ã‚Œã°ã€ã¨ã‚Šã‚ãˆãšç”Ÿãæ®‹ã£ã¦ã„ã‚‹ä¸­ã‹ã‚‰å¾—ç¥¨1ä½ã‚’å†ã‚»ãƒƒãƒˆ
                    if (activeMembers.length > 0) {
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš ï¸ å½“é¸è€…ãŒä¸åœ¨ã®ãŸã‚ã€æ¬¡ç‚¹å€™è£œã‚’ç¹°ã‚Šä¸Šã’ã¾ã™ã€‚", "", false);
                        chairman = activeMembers[0]; // æš«å®š
                        startElection(); // ã‚‚ã—ãã¯é¸æŒ™ã‚’ã‚„ã‚Šç›´ã™
                    } else {
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ’€ ç”Ÿå­˜è€…ãŒã„ãªã„ãŸã‚ã€å…¨æ»…ã—ã¾ã—ãŸ...", "", false);
                    }
                }

            }

            // âŒ éåŠæ•°ãªã— â†’ 3åã§ã®æ±ºé¸æŠ•ç¥¨ã¸
            let finalists = sorted.slice(0, 3).map(v => v[0]); // é€šå¸¸ã®ä¸Šä½3å
            is_vote = true;
            let prioritizedSuccessor = recommendedMember || successor;

            if (prioritizedSuccessor && !finalists.includes(prioritizedSuccessor.name)) {
                finalists[2] = prioritizedSuccessor.name; // 3ä½ã‚’è¹´è½ã¨ã—ã¦å¾Œç¶™è€…ãŒå‚æˆ¦
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ—³ï¸ å‰æ”¿æ¨©ã®æŒ‡åã«ã‚ˆã‚Šã€${prioritizedSuccessor.name} ãŒç‰¹ä¾‹ã§å€™è£œè€…ã«åŠ ã‚ã‚Šã¾ã—ãŸã€‚`, "", false);
            }

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                report + `\n<br />âš” éåŠæ•°ã«å±Šãã¾ã›ã‚“ã§ã—ãŸã€‚ä¸Šä½3åã«ã‚ˆã‚‹æ±ºé¸æŠ•ç¥¨ã‚’è¡Œã„ã¾ã™ã€‚\n<br />å€™è£œ: ${finalists.join(" / ")}`,
                "",
                false
            );

            runoffElection(finalists, round + 1);
        }

        function recordChairmanHistory() {
            if (!chairman || typeof chairman !== 'object' || !chairman.name) {
                console.warn("è¨˜éŒ²å¯¾è±¡ã®è­°é•·ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚");
                return;
            }

            const record = {
                name: chairman.name,
                image: chairman.image || chairman.aiImage,
                faction: chairman.faction ? chairman.faction.name : "ç„¡æ‰€å±",
                factionColor: chairman.faction ? chairman.faction.color : "#ccc",
                ideology: chairman.ideology,
                finalApproval: Math.floor(approvalRating),
                termEndReason: getTermEndReason(), // çµ‚äº†ç†ç”±
                date: new Date().toLocaleTimeString()
            };

            chairmanHistory.unshift(record); // æ–°ã—ã„é †ã«ä¿å­˜ï¼ˆå…ˆé ­ã«è¿½åŠ ï¼‰
        }

        // âœ… å¼•æ•°ã« round ã‚’è¿½åŠ 
        function saveElectionResult(votes, votersLog, round) {
            const timestamp = new Date().toLocaleTimeString();

            // å›æ•°ã«å¿œã˜ãŸé¸æŒ™åŒºåˆ†ã®åå‰
            let electionType = "æœ¬é¸æŒ™";
            if (round === 2) electionType = "æ±ºé¸æŠ•ç¥¨";
            if (round >= 3) electionType = `æœ€çµ‚æ±ºæˆ¦ (ç¬¬${round - 2}æ¬¡)`;

            // å¾—ç¥¨æ•°ã‚½ãƒ¼ãƒˆ
            const sortedResults = Object.entries(votes)
                .sort(([, a], [, b]) => b - a)
                .map(([name, count]) => {
                    const member = activeMembers.find(m => m.name === name) ||
                        (name === data.userName ? { image: data.userImage } : { image: "" });
                    return {
                        name: name,
                        count: count,
                        image: member.image || "default_icon.png"
                    };
                });

            const top = sortedResults[0];

            // å±¥æ­´ã«è¿½åŠ 
            electionHistory.push({
                id: electionHistory.length + 1, // é€šã—ç•ªå·
                roundName: electionType,        // â˜…ã“ã“ãŒæ–°ã—ã„ï¼ "æ±ºé¸æŠ•ç¥¨"ãªã©ãŒè¨˜éŒ²ã•ã‚Œã‚‹
                time: timestamp,
                winner: top,
                results: sortedResults,
                votersLog: votersLog
            });

            console.log(`é¸æŒ™å±¥æ­´ä¿å­˜(Round ${round}):`, electionHistory);
        }

        // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openHistory() {
            document.getElementById('historyModal').style.display = 'flex';
            renderHistoryList();
        }

        // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒªã‚¹ãƒˆï¼‰ã‚’æç”»
        function renderHistoryList() {
            const list = document.getElementById('historyList');
            list.innerHTML = "";

            // æ–°ã—ã„é †ã«è¡¨ç¤º
            [...electionHistory].reverse().forEach((rec) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
            <div>ç¬¬${rec.id}å› é¸æŒ™</div>
            <div class="history-date">${rec.time}</div>
            <div style="color:#ffd700">ğŸ‘‘ ${rec.winner.name}</div>
        `;
                div.onclick = () => showHistoryDetail(rec);
                list.appendChild(div);
            });
        }

        // è©³ç´°ç”»é¢ã‚’æç”»ï¼ˆã“ã“ãŒãƒ¡ã‚¤ãƒ³ï¼ï¼‰
        // è©³ç´°ç”»é¢ã‚’æç”»
        function showHistoryDetail(rec) {
            const container = document.getElementById('historyDetail');

            // 1ä½ã€2ä½ã‚’å–å¾—
            const first = rec.results[0];
            const second = rec.results[1] || { name: "å€™è£œãªã—", count: 0, image: "" };
            // 3ä½ã‚’å–å¾—ï¼ˆã„ãªã„å ´åˆã¯ undefined ã«ãªã‚‹ï¼‰
            const third = rec.results[2];

            // HTMLæ§‹ç¯‰
            let html = `
        <h3>ğŸ“Š ç¬¬${rec.id}å› ${rec.roundName || "æŠ•ç¥¨çµæœ"}</h3>
        
        <div class="vs-container" style="justify-content: center; gap: 15px;">
            <div class="candidate-big winner-glow">
                <img src="${first.image}" onerror="this.src=''">
                <div class="vote-count-big">${first.count}ç¥¨</div>
                <div>${first.name}</div>
                <div style="color:gold; font-size:0.8em; font-weight:bold;">WINNER</div>
            </div>
            
            <div class="vs-text" style="font-size:1.2em; margin:0 5px;">/</div>
            
            <div class="candidate-big" style="opacity: 0.9;">
                <img src="${second.image}" onerror="this.src=''">
                <div class="vote-count-big">${second.count}ç¥¨</div>
                <div>${second.name}</div>
                <div style="font-size:0.7em; color:#aaa;">2nd</div>
            </div>
    `;

            // ğŸš© 3ä½ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã‚’è¿½åŠ 
            if (third) {
                html += `
            <div class="vs-text" style="font-size:1.2em; margin:0 5px;">/</div>

            <div class="candidate-big" style="opacity: 0.6;">
                <img src="${third.image}" onerror="this.src=''">
                <div class="vote-count-big">${third.count}ç¥¨</div>
                <div>${third.name}</div>
                <div style="font-size:0.7em; color:#888;">3rd</div>
            </div>
        `;
            }

            // VSã‚¨ãƒªã‚¢ã‚’é–‰ã˜ã¦ã€ä¸‹éƒ¨ã®ãƒªã‚¹ãƒˆã¸
            html += `
        </div>
        <hr style="border-color:#444; margin:20px 0;">
        <h4>ğŸ—³ æŠ•ç¥¨å†…è¨³</h4>
        <div class="vote-breakdown">
    `;

            // å„å€™è£œè€…ã”ã¨ã®è©³ç´°ã‚«ãƒ¼ãƒ‰ä½œæˆ
            rec.results.forEach((candidate, index) => {
                const supporters = rec.votersLog.filter(log => log.votedFor === candidate.name);

                // é †ä½ã«å¿œã˜ãŸæ ç·šã®è‰²
                let borderStyle = "1px solid #444";
                if (index === 0) borderStyle = "2px solid gold";
                if (index === 1) borderStyle = "2px solid silver";
                if (index === 2) borderStyle = "2px solid #cd7f32"; // ãƒ–ãƒ­ãƒ³ã‚ºè‰²

                html += `
            <div class="candidate-card" style="border: ${borderStyle};">
                <div style="font-weight:bold; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span>${index + 1}. ${candidate.name}</span>
                    <span>${candidate.count}ç¥¨</span>
                </div>
                <div class="voter-icons">
                    ${supporters.map(s => `
                        <img src="${s.voterImg}" class="voter-mini" title="${s.voter} â†’ ${candidate.name}" onerror="this.style.display='none'">
                    `).join('')}
                </div>
            </div>
        `;
            });

            html += `</div>`;
            container.innerHTML = html;
        }

        // çµ‚äº†ç†ç”±ã‚’åˆ¤å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function getTermEndReason() {
            if (approvalRating < 20) return "è¾ä»»";
            if (!activeMembers.includes(chairman)) return "ç²›æ¸…ãƒ»æ¶ˆå¤±";
            return "ä»»æœŸæº€äº†";
        }

        function showHistory() {
            const list = document.getElementById("history-list");
            list.innerHTML = ""; // ã‚¯ãƒªã‚¢

            if (chairmanHistory.length === 0) {
                list.innerHTML = "<p style='text-align:center;'>ã¾ã æ­´å²ã«åˆ»ã¾ã‚ŒãŸè­°é•·ã¯ã„ã¾ã›ã‚“ã€‚</p>";
            }

            chairmanHistory.forEach((h, index) => {
                const item = document.createElement("div");
                item.style = `display:flex; align-items:center; background:#2a2a2a; margin-bottom:10px; padding:10px; border-radius:10px; border-left: 5px solid ${h.factionColor}`;
                item.innerHTML = `
            <img src="${h.image}" style="width:50px; height:50px; border-radius:50%; margin-right:15px; background:#444;">
            <div style="flex-grow:1;">
                <div style="font-weight:bold;">ç¬¬${chairmanHistory.length - index}ä»£: ${h.name}</div>
                <div style="font-size:0.8em; color:#aaa;">${h.ideology} | ${h.faction}</div>
                <div style="font-size:0.8em; color:${h.finalApproval < 40 ? '#ff6666' : '#66ff66'};">
                    æœ«æœŸæ”¯æŒç‡: ${h.finalApproval}% (${h.termEndReason})
                </div>
            </div>
            <div style="font-size:0.7em; color:#666;">${h.date}</div>
        `;
                list.appendChild(item);
            });

            document.getElementById("history-modal").style.display = "block";
        }

        async function runoffElection(finalists, round) {
            lastApproval = approvalRating;
            const votes = {};
            let scores = {};
            let candidatesObjs = finalists.map(name => {
                let m = activeMembers.find(am => am.name === name);
                if (!m && name === data.userName) return { name: data.userName, image: data.userImage, type: 'user' };
                return m;
            }).filter(v => v); // undefinedé™¤å»
            finalists.forEach(n => votes[n] = 0);
            let voteLogDetails = []; // â˜…ã“ã®ãƒ©ã‚¦ãƒ³ãƒ‰ç”¨ã®ãƒ­ã‚°
            // ğŸ¤– AI/NPCæŠ•ç¥¨
            for (let voter of activeMembers) {
                if (voter.name === data.userName) continue;
                if (voter.name === data.userName) continue;

                let scores = {};

                // å€™è£œè€…ã”ã¨ã«ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
                finalists.forEach(fName => {
                    scores[fName] = Math.random() * 5; // åŸºç¤ã‚¹ã‚³ã‚¢

                    const candidate = activeMembers.find(m => m.name === fName);
                    if (candidate) {
                        // âœ… æ­£ã—ã„ã‚¹ã‚³ãƒ¼ãƒ—ã§è¨ˆç®—
                        // 1. ä¸»ç¾©ã®ä¸€è‡´ãƒœãƒ¼ãƒŠã‚¹ (+15ç‚¹)
                        if (voter.ideology === candidate.ideology) {
                            scores[fName] += 15;
                        }

                        // 2. æ´¾é–¥ã®ä¸€è‡´ãƒœãƒ¼ãƒŠã‚¹ (+10ç‚¹)
                        if (voter.faction && candidate.faction && voter.faction.name === candidate.faction.name) {
                            scores[fName] += 10;
                        }

                        // 3. å¾Œç¶™è€…ãƒ»æŒ‡åãƒœãƒ¼ãƒŠã‚¹
                        if ((recommendedMember || successor)?.name === fName) {
                            let bonus = (lastApproval - 50) / 5;
                            scores[fName] += bonus;
                        }
                    }
                });

                if (npcskip) {

                    await sleep(5);
                    // å€™è£œè€…ï¼ˆfinalistsï¼‰ã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ï¼ˆã¾ãŸã¯çŸ¥çš„ã«ï¼‰é¸ã¶

                    let img = voter.aiImage || voter.image || "";
                    addBubble(voter.name, `ç§ã¯ ${pickName} ã«æŠ•ç¥¨ã—ã¾ã™ã€‚`, img, false);
                }
                let pickName = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
                votes[pickName] = (votes[pickName] || 0) + 1;
                voteLogDetails.push({ voter: voter.name, voterImg: voter.image, votedFor: pickName });
            }

            // ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æŠ•ç¥¨
            await sleep(300);
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ‘¤ ç¬¬${round}æ¬¡ æ±ºé¸æŠ•ç¥¨ã§ã™ã€‚3åã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚`, "", false);

            showVoteButtons(
                activeMembers.filter(m => finalists.includes(m.name)),
                (picked) => {
                    votes[picked.name] = (votes[picked.name] || 0) + 1;
                    is_vote = false;
                    votes[picked.name] = (votes[picked.name] || 0) + 1;
                    voteLogDetails.push({ voter: data.userName, voterImg: data.userImage, votedFor: picked.name });
                    addBubble(data.userName, `ç§ã¯ ${picked.name} ã«æŠ•ç¥¨ã—ã¾ã™ã€‚`, data.userImage || "", true);

                    // 3. ğŸ é›†è¨ˆã¨æ¬¡ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¤å®š
                    const sorted = Object.entries(votes).sort((a, b) => b[1] - a[1]);
                    const topVotes = sorted[0][1];
                    const secondVotes = sorted[1] ? sorted[1][1] : 0;
                    const totalVotes = Object.values(votes).reduce((a, b) => a + b, 0);

                    // å±¥æ­´ã«ä¿å­˜
                    saveElectionResult(votes, voteLogDetails, round);
                    // --- æ±ºç€ãƒ«ãƒ¼ãƒ« ---
                    let isDecided = false;

                    if (round === 2) {
                        // ä¸‰ã¤å·´ï¼šéåŠæ•°ãŒå¿…è¦
                        if (topVotes > totalVotes / 2) isDecided = true;
                    } else {
                        // æœ€çµ‚æ±ºæˆ¦ï¼ˆ2äººï¼‰ï¼š1ç¥¨ã§ã‚‚å¤šã‘ã‚Œã°å‹ã¡ã€‚åŒç‚¹ãªã‚‰æ³¥æ²¼ç¶™ç¶šã€‚
                        if (topVotes > secondVotes) isDecided = true;
                    }

                    if (isDecided) {
                        // ğŸ† æ±ºç€ï¼ finishElection ã«æŠ•ã’ã¦è­°é•·å°±ä»»ã¸
                        finishElection(votes, round);
                    } else {
                        // âŒ æ±ºç€ã¤ã‹ãš â†’ æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
                        let nextFinalists = [];
                        let message = "";

                        if (round === 2) {
                            // ä¸‰ã¤å·´ã§æ±ºã¾ã‚‰ãªã‹ã£ãŸ â†’ ä¸Šä½2åã§æœ€çµ‚æ±ºæˆ¦ã¸
                            nextFinalists = sorted.slice(0, 2).map(v => v[0]);
                            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                                `âš” ç¬¬3æ¥µã® ${sorted[2][0]} ãŒè„±è½ã€‚ä¸Šä½2åã«ã‚ˆã‚‹ã€æœ€çµ‚æ±ºé¸æŠ•ç¥¨ã€‘ã«ç§»ã‚Šã¾ã™ã€‚\n<br />æœ€çµ‚å€™è£œ: ${nextFinalists.join(" vs ")}`,
                                "",
                                false
                            );
                        } else {
                            // æœ€çµ‚æ±ºæˆ¦ã§åŒç‚¹ â†’ åŒã˜2åã§å†æŠ•ç¥¨
                            nextFinalists = [sorted[0][0], sorted[1][0]];
                            message = `âš ï¸æœ€çµ‚æ±ºæˆ¦ã«é€²ã¿ã¾ã™...`;
                        }

                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", message + `<br />å€™è£œ: ${nextFinalists.join(" vs ")}`, "", false);
                        setTimeout(() => runoffElection(nextFinalists, round + 1), 1000);
                    }
                });
        }
        // æ±ºé¸æŠ•ç¥¨ã®é›†è¨ˆãƒ­ã‚¸ãƒƒã‚¯
        function finishRunoff(votes, round) {
            let sorted = Object.entries(votes).sort((a, b) => b[1] - a[1]);
            let winner = sorted[0][0];
            let max = sorted[0][1];

            // ç·æŠ•ç¥¨æ•°
            let totalVotes = 0;
            for (let n in votes) totalVotes += votes[n];

            let report = `ğŸ“Š ${round >= 3 ? "æœ€çµ‚æ±ºæˆ¦" : "æ±ºé¸æŠ•ç¥¨"}çµæœ:\n`;
            sorted.forEach(v => report += `<br />${v[0]} : ${v[1]} ç¥¨`);

            // --- å‹åˆ©æ¡ä»¶åˆ¤å®š ---
            // ãƒ©ã‚¦ãƒ³ãƒ‰3ä»¥é™ï¼ˆæœ€çµ‚æ±ºæˆ¦ï¼‰ã¯ã€åŒç‚¹ã˜ã‚ƒãªã‘ã‚Œã°å³æ±ºå®šï¼ˆéåŠæ•°ãƒ«ãƒ¼ãƒ«æ’¤å»ƒã€å¤šæ•°æ±ºã®ã¿ï¼‰
            // ãƒ©ã‚¦ãƒ³ãƒ‰2ï¼ˆä¸‰ã¤å·´ï¼‰ã¯ã€éåŠæ•°ãŒå¿…è¦ã€‚ãƒ€ãƒ¡ãªã‚‰ä¸Šä½2åã§ãƒ©ã‚¦ãƒ³ãƒ‰3ã¸ã€‚

            let decided = false;

            if (round >= 3) {
                // æœ€çµ‚æ±ºæˆ¦: åŒç‚¹ã§ãªã‘ã‚Œã°æ±ºç€
                if (sorted.length > 1 && sorted[0][1] === sorted[1][1]) {
                    decide = false; // ãƒ‰ãƒ­ãƒ¼
                } else {
                    decided = true;
                }
            } else {
                // ä¸‰ã¤å·´: éåŠæ•°ãƒã‚§ãƒƒã‚¯
                if (max > totalVotes / 2) decided = true;
            }

            // --- çµæœåˆ†å² ---
            if (decided) {
                // â–  æ±ºç€ï¼
                // é€šå¸¸ãƒ«ãƒ¼ãƒ—ã¸æˆ»ã‚‹

            } else {
                // â–  æ³¥æ²¼ç¶™ç¶š...
                let nextCandidates = [];

                if (round === 2) {
                    // ä¸‰ã¤å·´ã§æ±ºã¾ã‚‰ãªã‹ã£ãŸ â†’ ä¸Šä½2åã§æœ€çµ‚æ±ºæˆ¦ã¸
                    nextCandidates = [sorted[0][0], sorted[1][0]];
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ", report + `\n<br />âš–ï¸ éåŠæ•°ãªã—ã€‚ä¸Šä½2åã«ã‚ˆã‚‹ã€æœ€çµ‚æ±ºæˆ¦ã€‘ã¸ç§»è¡Œã—ã¾ã™ã€‚`, "", false);
                } else {
                    // æœ€çµ‚æ±ºæˆ¦ã§åŒç‚¹ã ã£ãŸ â†’ åŒã˜ãƒ¡ãƒ³ãƒ„ã§å†æŠ•ç¥¨ï¼ˆç„¡é™ç·¨ï¼‰
                    nextCandidates = sorted.map(s => s[0]);
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ", report + `\n<br />âš ï¸ å¾—ç¥¨æ•°ãŒåŒæ•°ã§ã™ï¼ æ±ºç€ãŒã¤ãã¾ã§å†æŠ•ç¥¨ã‚’è¡Œã„ã¾ã™...`, "", false);
                }

                // å†å¸°å‘¼ã³å‡ºã—ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’ +1 ã™ã‚‹ï¼‰
                setTimeout(() => {
                    runoffElection(nextCandidates, round + 1);
                }, 2000);
            }
        }

        function nyukoku() {
            // é–å›½ä¸­ãªã‚‰å…¥å›½ä¸å¯ï¼ˆéæ¿€æ´¾ã®ä»•æ¥­ï¼‰
            if (sakoku) {
                // æ¬¡æœŸãƒªãƒ¼ãƒ€ãƒ¼ã®ãŸã‚ã«ç¢ºç‡ã§è§£é™¤ï¼ˆéæ¿€æ´¾ä»¥å¤–ãŒè­°é•·ãªã‚‰è§£é™¤ãªã©ï¼‰
                if (chairman && chairman.ideology !== "éæ¿€æ´¾" && Math.random() < 0.2) {
                    sakoku = false;
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ”“ ${chairman.name} ãŒé–å›½ä»¤ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`, "", false);
                } else {
                    return; // å…¥å›½æ‹’å¦
                }
            }

            // è­°é•·ã®æ€æƒ³ãƒã‚§ãƒƒã‚¯
            if (chairman) {
                const id = chairman.ideology;

                // â–  å…¥å›½æ‹’å¦åˆ¤å®š
                if (id === "ä¿å®ˆä¸»ç¾©" && Math.random() < 0.3) return; // 30%æ‹’å¦
                if (id === "ç‹¬è£è€…" && Math.random() < 0.65) return; // 65%æ‹’å¦
                if (id === "éæ¿€æ´¾") { // åŸºæœ¬æ‹’å¦ ï¼‹ é–å›½ç™ºå‹•
                    if (!sakoku) {
                        sakoku = true;
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `â›” éæ¿€æ´¾ã® ${chairman.name} ãŒã€Œé–å›½ã€ã‚’å®£è¨€ã—ã¾ã—ãŸï¼`, "", false);
                    }
                    return;
                }
            }

            // --- ã“ã“ã‹ã‚‰é€šå¸¸ã®å…¥å›½å‡¦ç† ---
            let globalKeys = Object.keys(data.brain);
            // ...ï¼ˆä¸­ç•¥ï¼špoolä½œæˆãªã©ï¼‰...

            // ç ´å£Šä¸»ç¾©ã¯å¤§é‡ã«å…¥ã‚Œã‚‹ãŸã‚ã€ç¢ºç‡ã§ã€Œã‚‚ã†ä¸€äººã€å‘¼ã¶
            if (chairman && chairman.ideology === "ç ´å£Šä¸»ç¾©" && Math.random() < 0.5) {
                setTimeout(chairmanInvite, 500);
            }

            let name = generateName(data.brain);
            let types = ["å…¥å›½è€…", "ç§»æ°‘", "ç•™å­¦ç”Ÿ"];
            let mType = types[Math.floor(Math.random() * types.length)];

            let newMember = {
                type: "ai",
                mType: mType,
                name,
                image: `https://api.dicebear.com/7.x/personas/svg?seed=${encodeURIComponent(name)}`,
                brain: JSON.parse(JSON.stringify(data.brain)),
                fav: (mType === "ç•™å­¦ç”Ÿ") ? "ï¼ˆå‹‰å¼·ä¸­ï¼‰" : "",
                isIndividual: true,
                // â˜…æ–°å…¥ã‚Šã«ã‚‚æ€æƒ³ã‚’ä¸ãˆã‚‹
                ideology: getRandomIdeology(),
                speechCount: 0
            };

            activeMembers.push(newMember);
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âœˆï¸ [${newMember.ideology}] ã® ${name} (${mType}) ãŒå…¥å›½ã—ã¾ã—ãŸã€‚`, "", false);
            renderCheckboxes(activeMembers);

        }

        function memberDeparture() {
            // å‚åŠ è€…ãŒå°‘ãªã™ãã‚‹ã¨ãã¯å¸°ã‚‰ãªã„
            if (activeMembers.length <= 1) return;

            // â˜…ã€ã“ã“ãŒé‡è¦ã€‘mTypeï¼ˆå…¥å›½ãƒ»ç§»æ°‘ãƒ»ç•™å­¦ç”Ÿï¼‰ã‚’æŒã£ã¦ã„ã‚‹AIã ã‘ã‚’æŠ½å‡º
            const migrants = activeMembers.filter(m => m.type === 'ai' && m.mType);

            // å€™è£œãŒã„ãªã„ï¼ˆå…¨å“¡åˆæœŸãƒ¡ãƒ³ï¼‰ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (migrants.length === 0) return;

            // å€™è£œã®ä¸­ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸€äººé¸ã¶
            const target = migrants[Math.floor(Math.random() * migrants.length)];

            // å‡ºå›½åˆ¤å®šï¼ˆç¢ºç‡ã¯å°‘ã—ä¸‹ã’ã¦ 5% ãã‚‰ã„ã«ã™ã‚‹ã¨å®‰å®šã—ã¾ã™ï¼‰
            if (target && Math.random() < 0.15) {
                activeMembers = activeMembers.filter(m => m !== target);

                if (target.faction) {
                    target.faction.members = target.faction.members.filter(m => m !== target);
                }

                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸƒ ${target.mType}ã® ${target.name} ã¯æ„›æƒ³ã‚’å°½ã‹ã—ã¦å‡ºå›½ã—ãŸã€‚`, "", false);
                renderCheckboxes(activeMembers); // UIæ›´æ–°
            }
        }

        // 1. æç”»é–¢æ•°ï¼šæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰(key)ã‚’å—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
        function renderMemberList(key = "") {
            const container = document.getElementById('memberList');
            if (!container) return;

            const lowerKey = key.toLowerCase();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ãŸãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const filtered = activeMembers.filter(m =>
                m.name.toLowerCase().includes(lowerKey)
            );

            container.innerHTML = filtered.map((m, index) => {
                // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(index)ã§ã¯ãªãã€Œåå‰ã€ã‚’ç›´æ¥é–¢æ•°ã«æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´ï¼ˆé‡è¦ï¼ï¼‰
                const safeName = m.name.replace(/'/g, "\\'");

                return `
            <div class="member-item" style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                <img src="${m.image || m.aiImage}" width="30" height="30" style="border-radius:50%; object-fit:cover;">
                <span style="flex:1;">${m.name}</span>
                <div class="member-controls">
                    <button onclick="window.openCustomizeModal('${safeName}')" style="cursor:pointer;">âš™ï¸</button>
                    <button onclick="window.triggerTrialByIdx('${safeName}')" style="cursor:pointer;">âš–ï¸</button>
                </div>
            </div>
        `;
            }).join('');
        }

        // 2. æ¤œç´¢ãƒãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š (HTMLå´ã®inputã« id="member-search" ãŒã‚ã‚‹å‰æ)
        document.getElementById('memberSearch')?.addEventListener('input', (e) => {
            renderMemberList(e.target.value);
        });
        let isPaused = false; // ãƒãƒ£ãƒƒãƒˆåœæ­¢ãƒ•ãƒ©ã‚°

        // 1. ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰ã®èµ·å‹•ç”¨
        window.triggerTrialByIdx = function (member) {
            const target = activeMembers.find(m => m.name.trim() === member.trim()) ||
                (member === data.userName ? { name: data.userName, image: data.userImage, ideology: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" } : null);

            if (!member) {
                console.error("å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:", member);
                return;
            }
            if (is_vote) {
                alert(`é¸æŒ™æœŸé–“ä¸­ã¯è£åˆ¤ã§ãã¾ã›ã‚“ã€‚`);
                return;
            }
            if (target.name === chairman.name) {
                alert(`äº‹ä»¶ãŒãªã„é™ã‚Šã€${chairmanTitle}ã‚’è£ãã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚`);
                return;
            }
            if (target.name === data.userName) {
                alert(`è‡ªã‚‰ã‚’è£ãã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚`);
                return;
            }
            if (target) {
                console.log("è£åˆ¤é–‹å§‹:", target.name); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
                startPurgeTrial(target);
            }
        };

        // 2. è£åˆ¤ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
        async function startPurgeTrial(defendant) {
            isPaused = true;
            const modal = document.getElementById('trialModal');
            modal.style.display = 'flex';

            // ãƒ¡ãƒ³ãƒãƒ¼é¸å®šï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ç²›æ¸…æ¸ˆã¿é™¤å¤–ï¼‰
            const eligibleAI = activeMembers.filter(m =>
                m.name !== defendant.name &&
                m.name !== data.userName &&
                !(expelled instanceof Set ? expelled.has(m.name) : (Array.isArray(expelled) && expelled.includes(m.name)))
            );

            const judges = eligibleAI.slice(0, 5);
            const audience = eligibleAI.slice(5, 17);

            // æç”»
            document.getElementById('judgesArea').innerHTML = judges.map((j, i) => createTrialIcon(j, "", "45px", true, `judge-node-${i}`)).join('');
            document.getElementById('accuserArea').innerHTML = createTrialIcon({ name: data.userName, image: data.userImage }, "åŸå‘Š", "55px", true);
            document.getElementById('defendantArea').innerHTML = createTrialIcon(defendant, "è¢«å‘Š", "85px", true, "defendant-img");
            document.getElementById('audienceArea').innerHTML = audience.map((a, i) => createTrialIcon(a, "", "35px", false, `audience-node-${i}`)).join('');

            const vText = document.getElementById('verdictText');
            const vName = document.getElementById('judgeSpeakerName');
            vText.innerText = "ğŸš¨ å¯©ç†ã‚’é–‹å§‹ã—ã¾ã™ã€‚";
            await wait(1000);

            // --- åˆ¤æ±ºãƒ•ã‚§ãƒ¼ã‚º ---
            let guiltyVotes = 0;
            const judgeNodes = document.querySelectorAll('#judgesArea .trial-char');

            for (let i = 0; i < judges.length; i++) {
                const isGuilty = Math.random() > 0.45;
                if (isGuilty) guiltyVotes++;

                // ãƒãƒƒãƒ—ã‚’ã€Œç›®ã«è¦‹ãˆã‚‹çŠ¶æ…‹ã€ã§è¿½åŠ 
                const tip = document.createElement('div');
                tip.className = 'judge-tooltip';
                tip.style.color = isGuilty ? "#ff4d4d" : "#4dff4d";
                tip.innerText = isGuilty ? "æœ‰ç½ª" : "ç„¡ç½ª";
                judgeNodes[i].appendChild(tip);

                vName.innerText = `[ è£åˆ¤å®˜: ${judges[i].name} ]`;
                vText.innerText = isGuilty ? "ã€Œ æœ‰ ç½ª ã€" : "ã€Œ ç„¡ ç½ª ã€";
                vText.style.color = isGuilty ? "#ff4d4d" : "#4dff4d";

                judgeNodes.forEach((el, idx) => el.style.opacity = (idx === i) ? "1" : "0.3");
                await wait(800);
            }

            // --- æœ€çµ‚åˆ¤æ±º ---
            const finalGuilty = guiltyVotes > (judges.length / 2);
            if (finalGuilty) {
                vText.innerText = "æ­» åˆ‘ (GUILTY)";
                vText.style.color = "red";

                // ã€è¿½åŠ ã€‘è¦³å®¢å¸­ã‹ã‚‰ã€Œæ­»åˆ‘ï¼ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                const audienceNodes = document.querySelectorAll('#audienceArea .trial-char');
                audienceNodes.forEach((node, i) => {
                    setTimeout(() => {
                        const chant = document.createElement('div');
                        chant.className = 'death-chant';
                        chant.innerText = 'æ­»åˆ‘ï¼';
                        chant.style.left = `${Math.random() * 20 - 10}px`;
                        chant.style.top = `-20px`;
                        node.appendChild(chant);
                    }, i * 100);
                });

                // éºå½±åŒ–ã¨ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
                document.getElementById('trialStage').style.boxShadow = "0 0 100px #f00";
                const defImg = document.getElementById('defendant-img');
                if (defImg) defImg.style.filter = "grayscale(100%) brightness(0.6) contrast(1.5)";

                celebrateSuccess();
                await wait(4000);
                purgeMember(defendant, "è£åˆ¤ã«ã‚ˆã£ã¦");
            } else {
                vText.innerText = "é‡ˆ æ”¾ (NOT GUILTY)";
                vText.style.color = "#00ff00";
                await wait(2000);
            }

            modal.style.display = 'none';
            isPaused = false;
        }

        // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆé–¢æ•°ã®å¾®èª¿æ•´
        function createTrialIcon(member, label, size, showName, imgId = "") {
            // è¦³å®¢(showName=false)ã®å ´åˆã¯åå‰ã‚’å‡ºã•ãªã„
            return `
        <div class="trial-char" style="text-align:center; min-width:${size}; position:relative;">
            <img id="${imgId}" src="${member.image || member.aiImage}" style="width:${size}; height:${size}; border-radius:50%; border:1.5px solid gold; object-fit:cover; display:block; margin:0 auto; background:#222;">
            ${showName ? `
                <div style="font-size:9px; color:white; margin-top:4px; line-height:1.1;">
                    ${label ? `<b style="color:gold;">${label}</b><br>` : ""}
                    ${member.name.substring(0, 8)}
                </div>
            ` : ""}
        </div>
    `;
        }

        function createTrialIcon(member, label, size) {
            return `
        <div class="trial-char" style="text-align:center; min-width:${size};">
            <img src="${member.image || member.aiImage}" style="width:${size}; height:${size}; border-radius:50%; border:1px solid gold; object-fit:cover; display:block; margin:0 auto;">
            <div style="font-size:8px; color:white; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:${size};">${label ? `<b>${label}</b><br>` : ""}${member.name}</div>
        </div>
    `;
        }

        function celebrateSuccess() {
            // è¢«å‘Šäººï¼ˆdefendantAreaï¼‰ä»¥å¤–ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è·³ã­ã•ã›ã‚‹
            const targets = document.querySelectorAll('#judgesArea .trial-char, #audienceArea .trial-char, #accuserArea .trial-char');
            targets.forEach((el, i) => {
                setTimeout(() => {
                    el.animate([
                        { transform: 'translateY(0)' },
                        { transform: 'translateY(-15px)' },
                        { transform: 'translateY(0)' }
                    ], { duration: 300, iterations: 6 });
                }, i * 30);
            });
        }
        // ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
        function createTrialIcon(member, label, size = "60px") {
            return `
        <div class="trial-char" style="text-align:center; transition: 0.3s;">
            <img src="${member.image || member.aiImage}" style="width:${size}; height:${size}; border-radius:50%; border:2px solid gold; object-fit:cover; background:#fff;">
            <div style="font-size:10px; color:white; margin-top:4px;"><b>${label}</b><br>${member.name}</div>
        </div>
    `;
        }

        // å¾…ã¡é–¢æ•°
        const wait = ms => new Promise(res => setTimeout(res, ms));

        function generateFactionName() {
            let keys = generateName(data.brain);
            if (!keys.length) keys = ["æ–°ç”Ÿ", "æ”¹é©", "æœªæ¥", "ä¸­å¤®"];

            let base = generateName(data.brain);
            let tails = ["æ´¾é–¥", "æ´¾", "é€£åˆ", "å…š", "ã®ä¼š"];

            return base + tails[Math.floor(Math.random() * tails.length)];
        }

        function createFaction(founder, others = []) {
            // æ´¾é–¥ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ã¯ãã®ã¾ã¾ï¼‰
            if (factions.length >= 5) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš ï¸ æ´¾é–¥ãŒå¤šã™ãã¦ã“ã‚Œä»¥ä¸Šçµæˆã§ãã¾ã›ã‚“ã€‚", "", false);
                return;
            }

            // â˜… ä¿®æ­£ï¼šfounderã‚’é…åˆ—ã«å…¥ã‚Œã€ã¾ã æ´¾é–¥ã«å±ã—ã¦ã„ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ã‚’æŠ½å‡º
            let members = [founder, ...others].filter(m => m && !m.faction);

            // â˜… ä¿®æ­£ï¼š1äººï¼ˆè‡ªåˆ†ã ã‘ï¼‰ã§ã‚‚çµæˆã§ãã‚‹ã‚ˆã†ã«ã€Œ1ã€ã«å¤‰æ›´
            if (members.length < 1) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš ï¸ ã™ã§ã«æ´¾é–¥ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ã€æœ‰åŠ¹ãªãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚", "", false);
                return;
            }

            let name = generateFactionName(); // ã‚‚ã—å¼•æ•°ã§åå‰ã‚’æ¸¡ã›ã‚‹ãªã‚‰(name || generateFactionName())ã«ã™ã‚‹

            let faction = {
                name,
                members: [],
                leader: founder,
                alive: true,
                color: `#${Math.floor(Math.random() * 16777215).toString(16)}`, // æ——ã®è‰²
                banned: [] // â˜…ã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚Setã§ã¯ãªãé…åˆ—ã«ã—ã¦ãŠãã¾ã™
            };

            members.forEach(m => {
                m.faction = faction;
                faction.members.push(m);
            });

            factions.push(faction);

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸš© ${founder.name} ãŒæ–°æ´¾é–¥ã€Œ${name}ã€ã‚’æ——æšã’ã—ã¾ã—ãŸï¼`,
                "",
                false
            );

            renderFactionBar(); // UIæ›´æ–°
            return faction; // ä½œæˆã—ãŸæ´¾é–¥ã‚’è¿”ã™
        }

        function joinFaction(member, faction) {
            if (!faction || !faction.alive) return;
            if (member.faction) return;

            const isUser = member.name === data.userName;

            // é™¤åãƒã‚§ãƒƒã‚¯
            if (faction.banned.includes(member)) {
                addBubble({ name: "ã‚·ã‚¹ãƒ†ãƒ ", faction },
                    `âš  ${member.name} ã¯ ${faction.name} ã‹ã‚‰é™¤åã•ã‚Œã¦ã„ã¾ã™ã€‚`
                );
                return; // â† ã“ã“ã§ return
            }

            // åŠ å…¥å‡¦ç†
            member.faction = faction;
            faction.members.push(member);

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡ºåŠ›
            if (isUser) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                    `âœ… ã‚ãªãŸã¯ ${faction.name} ã«å‚åŠ ã—ã¾ã—ãŸï¼`,
                    "",
                    false
                );
            } else {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                    `â• ${member.name} ã¯ ${faction.name} ã«åŠ ç›Ÿã—ãŸã€‚`,
                    "",
                    false
                );
            }

            renderFactionBar();
        }




        // æ´¾é–¥è„±é€€ãƒ»å‚åŠ 
        function userDeclaresFaction(factionName) {
            const member = activeMembers.find(m => m.name === data.userName);
            const faction = factions.concat(deadFactions).find(f => f.name === factionName && f.alive);

            if (!member) return;

            if (!faction) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš ï¸ ã€Œ${factionName}ã€ã«ã¯å‚åŠ ã§ãã¾ã›ã‚“ã€‚å­˜åœ¨ã—ãªã„ã‹ã€ã™ã§ã«æ´»å‹•ã—ã¦ã„ãªã„æ´¾é–¥ã§ã™ã€‚`, "", false);
                return;
            }

            joinFaction(member, faction);
        }

        function expelFromFaction(member, faction) {
            if (!member.faction || member.faction !== faction) return;

            // æ´¾é–¥ã‹ã‚‰è„±é€€
            leaveFaction(member);

            // é™¤åãƒªã‚¹ãƒˆã«è¿½åŠ 
            faction.banned.push(member);

            addBubble({ name: "ã‚·ã‚¹ãƒ†ãƒ ", faction }, `âš  ${member.name} ã¯ ${faction.name} ã‹ã‚‰é™¤åã•ã‚Œã¾ã—ãŸ`);
        }


        function userDeclaresFactionleave(factionName) {
            // æ‰€å±æ´¾é–¥ã‚’æ¢ã™
            const faction = factions.find(f => f.name === factionName && f.alive);
            if (!faction) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš ï¸ ã€Œ${factionName}ã€ã‹ã‚‰è„±é€€ã§ãã¾ã›ã‚“ã€‚å­˜åœ¨ã—ãªã„ã‹ã€æ´»å‹•ã—ã¦ã„ãªã„æ´¾é–¥ã§ã™ã€‚`, "", false);
                return;
            }

            // ãƒ¡ãƒ³ãƒãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ´¾é–¥ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰æ¢ã™
            const member = faction.members.find(m => m.name === data.userName);
            if (!member) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš ï¸ ã‚ãªãŸã¯ã€Œ${factionName}ã€ã«æ‰€å±ã—ã¦ã„ã¾ã›ã‚“ã€‚`, "", false);
                return;
            }

            leaveFaction(member); // å®Ÿéš›ã«è„±é€€
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âœ… ã‚ãªãŸã¯ã€Œ${factionName}ã€ã‹ã‚‰è„±é€€ã—ã¾ã—ãŸã€‚`, "", false);
        }

        function userDeclaresFactionbuild(factionName) {
            if (!data.factions) data.factions = [];

            // 1. è‡ªåˆ†ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’ã—ã£ã‹ã‚Šæ¢ã™
            const me = activeMembers.find(m => m.name === data.userName);
            if (!me) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš ï¸ ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", "", false);
                return;
            }

            // 2. æ‰€å±ãƒ»é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (me.faction) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš ï¸ ã™ã§ã«ã€Œ${me.faction.name}ã€ã«æ‰€å±ã—ã¦ã„ã¾ã™ã€‚`, "", false);
                return;
            }
            const duplicate = data.factions.find(f => f.name === factionName);
            if (duplicate) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš ï¸ ã€Œ${factionName}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`, "", false);
                return;
            }

            // 3. çµå…šå®Ÿè¡Œï¼ (createFaction ã« me ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™)
            let newFac = createFaction(me);

            // 4. åå‰ã‚’å…¥åŠ›ã•ã‚ŒãŸã‚‚ã®ã«ä¸Šæ›¸ãã™ã‚‹
            if (newFac && factionName) {
                newFac.name = factionName;
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸš© æ´¾é–¥ã€Œ${factionName}ã€ã‚’ä¸€äººã§çµæˆã—ã¾ã—ãŸï¼`, "", false);
            }

            if (typeof renderFactionBar === 'function') renderFactionBar();
        }







        function leaveFaction(member) {
            if (!member.faction) return;

            let faction = member.faction;

            faction.members = faction.members.filter(m => m !== member);
            member.faction = null;

            addBubble(member.name,
                `ç§ã¯${faction.name}ã‹ã‚‰è„±é€€ã—ã¾ã™`,
                "",
                false
            );

            if (faction.members.length === 0) {
                faction.alive = false;
                factions = factions.filter(f => f !== faction);
                deadFactions.push(faction);
            }

            renderFactionBar();
        }
        function mergeFactions(a, b) {
            if (!a || !b) return;
            if (a === b) return;

            b.members.forEach(m => {
                m.faction = a;
                a.members.push(m);
            });

            b.alive = false;
            factions = factions.filter(f => f !== b);
            deadFactions.push(b);

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸ”€ ${b.name} ã¯ ${a.name} ã«åˆæµã—ãŸã€‚`,
                "",
                false
            );

            renderFactionBar();
        }
        function maybeFactionExpel() {
            if (!factions.length) return;
            let faction = factions[Math.floor(Math.random() * factions.length)];
            if (!faction || faction.members.length <= 1) return;

            let candidates = faction.members.filter(m => m !== faction.leader);
            if (!candidates.length) return;

            let removeCount = Math.floor(Math.random() * candidates.length) + 1;
            for (let i = 0; i < removeCount; i++) {
                if (!candidates.length) break;
                let idx = Math.floor(Math.random() * candidates.length);
                let m = candidates.splice(idx, 1)[0];

                expelFromFaction(m, faction);
            }
        }


        function maybeFactionAction() {
            // NPCã®ã¿å¯¾è±¡
            const npcMembers = activeMembers.filter(m => m.name !== data.userName);

            let r = Math.random();

            // æ–°æ´¾é–¥ä½œæˆ
            if (r < 0.25 && factions.length < 5) {
                let pool = npcMembers.filter(m => !m.faction);
                if (pool.length >= 2) {
                    let a = pool[Math.floor(Math.random() * pool.length)];
                    let b = pool[Math.floor(Math.random() * pool.length)];
                    if (a !== b) createFaction(a, [b]);
                }
            }

            // NPCã‚’æ—¢å­˜æ´¾é–¥ã«åŠ å…¥
            else if (r < 0.5 && factions.length) {
                let faction = factions[Math.floor(Math.random() * factions.length)];
                let pool = npcMembers.filter(m => !m.faction && !faction.banned.includes(m));
                if (pool.length) {
                    joinFaction(pool[Math.floor(Math.random() * pool.length)], faction);
                }
            }


            // æ´¾é–¥åˆä½µ
            else if (r < 0.7 && factions.length >= 2) {
                let a = factions[Math.floor(Math.random() * factions.length)];
                let b = factions[Math.floor(Math.random() * factions.length)];
                if (a !== b) mergeFactions(a, b);
            }

            // NPCãŒæ´¾é–¥ã‚’æŠœã‘ã‚‹
            else if (r < 0.9) {
                let pool = npcMembers.filter(m => m.faction && m.name !== data.userName);
                if (pool.length) leaveFaction(pool[Math.floor(Math.random() * pool.length)]);
            }

            // --- é™¤åå‡¦åˆ† ---
            if (Math.random() < 0.1) { // 10% ç¢ºç‡ã§é™¤åã‚¤ãƒ™ãƒ³ãƒˆ
                maybeFactionExpel();
            }


        }




        function playerJoinFaction(faction) {
            let player = activeMembers.find(m => m.type === data.userName);
            if (player) joinFaction(player, faction);
        }

        function playerLeaveFaction() {
            let player = activeMembers.find(m => m.type === data.userName);
            if (player) leaveFaction(player);
        }

        function maybeCreateFaction() {
            if (Math.random() > 0.05) return;

            let pool = activeMembers.filter(m => !m.faction);
            if (pool.length < 2) return;

            let founder = pool[Math.floor(Math.random() * pool.length)];
            let mate = pool[Math.floor(Math.random() * pool.length)];

            if (founder !== mate) {
                createFaction(founder, [mate]);
            }
        }

        function checkFactionCommand(member, text) {
            if (!member.faction) return;

            if (text.includes("è„±é€€")) {
                leaveFaction(member);
            }
        }






        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        function openChairmanPanel() {
            document.getElementById("chairmanPanel").style.display = "block";
        }

        function closeChairmanPanel() {
            document.getElementById("chairmanPanel").style.display = "none";
        }

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãŒåŠ å…¥ãƒ»è„±é€€ã—ãŸéš›ã«å‘¼ã¶ï¼‰
        function updateChecklist() {
            const container = document.getElementById("member-checkboxes");
            if (!container) return;

            const chairmanName = chairman ? chairman.name : null;

            // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã«é©ã—ãŸã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªãƒ©ãƒ™ãƒ«æ§‹é€ 
            container.innerHTML = activeMembers
                .filter(m => m && m.name !== chairmanName)
                .map(m => `
            <label style="display: flex; align-items: center; font-size: 12px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <input type="checkbox" class="kick-checkbox" value="${m.name}" style="margin-right: 4px;"> 
                ${m.name}
            </label>
        `).join("");
        }

        // å…¨é¸æŠãƒ»è§£é™¤ç”¨ã®ä¾¿åˆ©é–¢æ•°
        function selectAll(bool) {
            const checkboxes = document.querySelectorAll('.kick-checkbox');
            checkboxes.forEach(cb => cb.checked = bool);
        }


        let currentMode = ""; // "kick" ã‹ "release" ã‚’ä¿æŒ

        // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
        function closePanel() {
            document.getElementById("chairman-panel").style.display = "none";
        }

        // å…¨é¸æŠãƒ»è§£é™¤
        function selectAll(bool) {
            const checkboxes = document.querySelectorAll('.target-checkbox');
            checkboxes.forEach(cb => cb.checked = bool);
        }

        // è¿½æ”¾ãƒ‘ãƒãƒ«ã‚’é–‹ã
        function openKickPanel() {
            currentMode = "kick";
            document.getElementById("panel-title").innerText = "âš– è¿½æ”¾å¯¾è±¡ã‚’é¸æŠ";
            document.getElementById("panel-confirm-btn").innerText = "è¿½æ”¾å®Ÿè¡Œ";
            document.getElementById("panel-confirm-btn").onclick = executeChairmanAction;

            const list = activeMembers.filter(m => m.name !== chairman?.name);
            renderCheckboxes(list);
            document.getElementById("chairman-panel").style.display = "block";
        }

        // é‡ˆæ”¾ãƒ‘ãƒãƒ«ã‚’é–‹ã
        function openReleasePanel() {
            currentMode = "release";
            document.getElementById("panel-title").innerText = "ğŸ”“ é‡ˆæ”¾å¯¾è±¡ã‚’é¸æŠ";
            document.getElementById("panel-confirm-btn").innerText = "é‡ˆæ”¾å®Ÿè¡Œ";
            document.getElementById("panel-confirm-btn").onclick = executeChairmanAction;

            // expelled (Set or Array) ã‚’é…åˆ—ã«å¤‰æ›
            const list = Array.from(expelled || []);
            renderCheckboxes(list);

            if (list.length === 0) {
                alert("è¿½æ”¾ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            document.getElementById("chairman-panel").style.display = "block";
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®æç”»ãƒ»å†æç”»
        function renderCheckboxes(members) {
            const container = document.getElementById("panel-checkboxes");
            container.innerHTML = "";

            container.innerHTML = members.map(m => `
        <label style="font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <input type="checkbox" class="target-checkbox" value="${m.name}"> ${m.name}
        </label>
    `).join("");
        }

        // æ¨è–¦ãƒ‘ãƒãƒ«ã‚’é–‹ã
        function openRecommendPanel() {
            currentMode = "recommend";
            document.getElementById("panel-title").innerText = "â­ å¾Œç¶™è€…ã‚’æ¨è–¦";
            document.getElementById("panel-confirm-btn").innerText = "æ¨è–¦ã™ã‚‹";
            document.getElementById("panel-confirm-btn").onclick = executeChairmanAction;

            // è‡ªåˆ†ï¼ˆè­°é•·ï¼‰ä»¥å¤–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
            const list = activeMembers.filter(m => m.name !== chairman?.name);
            renderCheckboxes(list);

            if (list.length === 0) {
                alert("æ¨è–¦ã§ãã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚");
                return;
            }
            document.getElementById("chairman-panel").style.display = "block";
        }

        // executeChairmanAction é–¢æ•°ã®ä¸­ã«ä»¥ä¸‹ã‚’è¿½è¨˜ï¼ˆã¾ãŸã¯å·®ã—æ›¿ãˆï¼‰
        function executeChairmanAction() {
            const selectedNames = Array.from(document.querySelectorAll('.target-checkbox:checked')).map(cb => cb.value);

            if (selectedNames.length === 0) {
                alert("å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const title = typeof chairmanTitle !== 'undefined' ? chairmanTitle : 'è­°é•·';

            if (currentMode === "kick") {
                // è¿½æ”¾å‡¦ç†
                const targets = activeMembers.filter(m => selectedNames.includes(m.name));
                activeMembers = activeMembers.filter(m => !selectedNames.includes(m.name));

                targets.forEach(m => {
                    // è¿½æ”¾ãƒªã‚¹ãƒˆã«è¿½åŠ 
                    if (expelled instanceof Set) expelled.push(m);
                    else expelled.push(m);

                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”Ÿå­˜åˆ¤å®š
                    if (m.type === "user") playerAlive = false;

                    // â˜… æ´¾é–¥ã‹ã‚‰ã®å¼·åˆ¶è„±é€€
                    // ãƒ¡ãƒ³ãƒãƒ¼å€‹äºº(m)ãŒæ´¾é–¥ã«å±ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦å®Ÿè¡Œ
                    if (m.faction) {
                        leaveFaction(m);
                    }
                });

                const title = typeof chairmanTitle !== 'undefined' ? chairmanTitle : 'è­°é•·';
                const msg = selectedNames.length > 1 ? `ğŸ’€ ${chairmanTitle}ã«ã‚ˆã‚‹ **å¤§ç²›æ¸…**` : `âš– ${chairmanTitle}ã¯ ${selectedNames[0]} ã‚’è¿½æ”¾`;
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", msg, selectedNames.length > 1 ? `å¯¾è±¡: ${selectedNames.join(", ")}` : "", false);
            } else if (currentMode === "release") {
                // é‡ˆæ”¾å‡¦ç†
                const expelledList = Array.from(expelled);
                const targets = expelledList.filter(m => selectedNames.includes(m.name));

                targets.forEach(member => {
                    if (expelled instanceof Set) expelled.filter(member);
                    else {
                        const idx = expelled.indexOf(member);
                        if (idx > -1) expelled.splice(idx, 1);
                    }
                    activeMembers.push(member);
                    if (member.type === "user") playerAlive = true;
                });

                const msg = selectedNames.length > 1 ? `ğŸ•Š ${chairmanTitle}ã«ã‚ˆã‚‹ **å¤§èµ¦ï¼ˆæ©èµ¦ï¼‰**` : `ğŸ”“ ${chairmanTitle}ã¯ ${selectedNames[0]} ã‚’é‡ˆæ”¾`;
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", msg, selectedNames.length > 1 ? `å¯¾è±¡: ${selectedNames.join(", ")}` : "", false);
            } else if (currentMode === "recommend") {
                // æ¨è–¦å‡¦ç†
                // è¤‡æ•°é¸ã°ã‚Œã¦ã„ã¦ã‚‚æœ€åˆã®ä¸€äººã‚’æ¡ç”¨
                const targetName = selectedNames[0];
                const target = activeMembers.find(m => m.name === targetName);

                if (target) {
                    recommendedMember = target;
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                        `â­ ${title}ã¯ ${target.name} ã‚’æ¬¡æœŸ${chairmanTitle}ã¨ã—ã¦æ¨è–¦ã—ã¾ã—ãŸã€‚`,
                        "ï¼ˆæ¬¡å›ã®é¸æŒ™ã§ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ç¥¨ãŒé›†ã¾ã‚Šã‚„ã™ããªã‚Šã¾ã™ï¼‰",
                        false
                    );
                }
            }

            closePanel();
        }





        function chairmanResign() {
            if (!chairman) return;
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸ³ ${chairmanTitle}ã¯è¾ä»»ã—ã¾ã—ãŸã€‚`,
                "",
                false
            );

            recommendedMember = null;
            closeChairmanPanel();
            clearCurrentTerm(); // ã‚¿ã‚¤ãƒãƒ¼ç ´æ£„
            startElection();    // ã™ãã«é¸æŒ™
        }


        function pickRandomMember() {
            let pool = activeMembers.filter(m => m.name !== chairman.name);
            return pool[Math.floor(Math.random() * pool.length)];
        }




        // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
        function switchMode(newMode, el) {
            mode = newMode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');

            document.getElementById('settings-panel').style.display = 'none';
            stopConference();
            document.getElementById('messages').innerHTML = "";

            const confSettings = document.getElementById('conf-settings');
            const confControls = document.getElementById('conf-header-controls');
            const header = document.getElementById('header-title');

            if (mode === 'conference') {
                header.innerText = "ä¼šè­°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—";
                confControls.style.display = 'block';
                confSettings.style.display = 'block';
                renderModSelect();
            } else {
                header.innerText = data.aiName;
                confControls.style.display = 'none';
                confSettings.style.display = 'none';
            }
        }

        function toggleSettings() {
            const p = document.getElementById('settings-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        function toggleConference() {
            // 1. ã™ã§ã«å‹•ã„ã¦ã„ã‚‹å ´åˆã¯åœæ­¢å‡¦ç†
            if (conferenceRunning) {
                stopConference();
                return;
            }

            // --- ãƒªã‚»ãƒƒãƒˆå‡¦ç† ---
            clearTimeout(chairmanTimer);
            is_vote = false;
            expelled = [];
            playerAlive = true;
            closePanel();
            // ------------------

            activeMembers = [];

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‚åŠ ãƒã‚§ãƒƒã‚¯
            if (document.getElementById('chk-user').checked) {
                activeMembers.push({ type: 'user', name: data.userName, image: data.userImage });
            }

            // â˜…ä¿®æ­£ç®‡æ‰€ï¼šäºŒé‡ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã€1å›ã®ãƒ«ãƒ¼ãƒ—ã§å‡¦ç†ã‚’å®Œäº†ã•ã›ã‚‹
            document.querySelectorAll('.clone-item').forEach(item => {
                // å®‰å…¨ã«è¦ç´ ã‚’å–å¾—ï¼ˆnullãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
                const nameEl = item.querySelector('.clone-name-input');
                const favEl = item.querySelector('.clone-fav-word');
                const ngEl = item.querySelector('.clone-ng-word');
                const typeEl = item.querySelector('.clone-brain-type');
                const imgEl = item.querySelector('.clone-icon-preview');

                // å€¤ã®å–å¾—ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                const name = nameEl ? nameEl.value : "AI";
                const fav = favEl ? favEl.value : "";
                const ng = ngEl ? ngEl.value : "";
                const type = typeEl ? typeEl.value : "share";
                const img = imgEl ? imgEl.src : data.aiImage;

                // è„³ã®è¨­å®š
                let targetBrain;
                if (type === 'individual') {
                    targetBrain = item.aiSpecificBrain || {};
                } else if (type === 'empty') {
                    targetBrain = {};
                } else {
                    targetBrain = data.brain;
                }

                // ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆã“ã“ãŒ1å›ã ã‘å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ï¼‰
                activeMembers.push({
                    type: 'ai',
                    name: name,
                    image: img,
                    brain: targetBrain,
                    fav: fav,
                    ng: ng,
                    isIndividual: (type !== 'share'),
                    ideology: getRandomIdeology(),
                    speechCount: 0
                });
            });

            if (activeMembers.length < 2) return alert("2äººä»¥ä¸Šå¿…è¦ã§ã™");

            conferenceRunning = true;
            const btn = document.getElementById('conf-toggle-btn');
            btn.innerText = "åœæ­¢ â– "; btn.className = "btn btn-red";
            document.getElementById('conf-settings').style.display = 'none';
            document.getElementById('header-title').innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ä¼šè­°é–‹å§‹ã€‚AIãŸã¡ã¯äº’ã„ã«å­¦ç¿’ã—ã€é–¢ä¿‚ã‚’ç¯‰ãã¾ã™ã€‚", "", false);

            document.getElementById("panel-checkboxes").innerHTML = "";
            renderCheckboxes(activeMembers);

            if (chairmanMode) {
                if (electionMode === "vote") {
                    startElection();
                } else {
                    openChairmanPanel();
                }
            }
            if (!chairmanMode) {
                openChairmanPanel();

            }

            runConferenceLoop("");
        }
        async function groksays(hatugen) {
            const syabe = await puter.ai.chat(hatugen, {
                model: "x-ai/grok-4.1-fast",
            });
            return syabe;
        }


        function stopConference() {
            conferenceRunning = false;
            if (conferenceTimer) clearTimeout(conferenceTimer);
            if (termTimer) clearTimeout(termTimer);

            // ãƒ‘ãƒãƒ«ã‚’éš ã™
            const panel = document.getElementById("status-panel");
            if (panel) panel.style.display = "none";
            clearTimeout(conferenceTimer);
            const btn = document.getElementById('conf-toggle-btn');
            if (btn) { btn.innerText = "é–‹å§‹ â–¶"; btn.className = "btn btn-green"; }
            if (mode === 'conference') {
                document.getElementById('conf-settings').style.display = 'block';
                document.getElementById('header-title').innerText = "ä¼šè­°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—";
            }
        }
        function purgeMember(target, reason) {
            if (!activeMembers.includes(target)) return;
            if (chairman === target) {
                clearCurrentTerm(); // è­°é•·ãŒæ¶ˆã•ã‚Œã‚‹ãªã‚‰ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                setTimeout(startElection, 2000); // 2ç§’å¾Œã«é¸æŒ™
            }
            if (target.faction) {
                approvalRating -= 2;
                leaveFaction(target); // æ—¢å­˜é–¢æ•°ã‚’ä½¿ã†
            }

            expelled.push(target); // åå‰ã‚’ä¿å­˜
            activeMembers = activeMembers.filter(m => m !== target);
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ’€ ${reason}ã«ã‚ˆã‚Šã€${target.name} ãŒç²›æ¸…ã•ã‚Œã¾ã—ãŸã€‚`, "", false);
            renderCheckboxes(activeMembers);
            setTimeout(() => {
                const firstSpeaker = chairman
                const starterText = `${target.name}ã‚’è¿½æ”¾ã—ãŸã€‚`;

                // ãƒ«ãƒ¼ãƒ—ã®èµ·ç‚¹ã‚’ä½œã‚‹
                addBubble(chairman.name, starterText, chairman.image || chairman.aiImage, false);
                runConferenceLoop(starterText);
            }, 1500);

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ­»ã‚“ã å ´åˆ
            if (target.type === 'user') {
                alert("ã‚ãªãŸã¯ç²›æ¸…ã•ã‚Œã¾ã—ãŸ...");
                playerAlive = false
            }
        }
        function runConferenceLoop(lastTopic) {

            if (!conferenceRunning) return;
            // --- ç¢ºç‡ã‚¤ãƒ™ãƒ³ãƒˆ ---
            if (Math.random() < 0.1) { // 10%ã®ç¢ºç‡ã§èª°ã‹ãŒå…¥å›½
                nyukoku();
            }
            if (Math.random() < 0.05) { // 5%ã®ç¢ºç‡ã§èª°ã‹ãŒå‡ºå›½
                memberDeparture();
            }

            const ais = activeMembers.filter(m => m.type === 'ai');
            if (ais.length === 0) return;

            const speaker = ais[Math.floor(Math.random() * ais.length)];

            // è©±ã—ã‹ã‘ã‚‹ç›¸æ‰‹ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸€äººæ±ºã‚ã‚‹ï¼ˆæš´è¨€åˆ¤å®šç”¨ï¼‰
            const targetMember = activeMembers[Math.floor(Math.random() * activeMembers.length)];

            conferenceTimer = setTimeout(() => {
                if (!conferenceRunning) return;
                if (activeMembers.length < 2) {
                    addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "âš  å‚åŠ è€…ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ä¸€éƒ¨ã®äººã‚’é‡ˆæ”¾ã—ã¾ã™ã€‚", "", false);
                    if (expelled.size > 0) {
                        let r = expelled.values().next().value;
                        expelled.filter(r);
                        activeMembers.push(r);
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âœ… ${r.name} ã‚’é‡ˆæ”¾ã—ã¾ã—ãŸã€‚`, "", false);
                        document.getElementById('header-title').innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;
                    } else {
                        stopConference();
                        return;
                    }
                }

                if (chairman && chairman !== speaker) {
                    const id = chairman.ideology;
                    const isMigrant = !!speaker.mType; // ç§»æ°‘ã‹ã©ã†ã‹

                    // 1. å¹³ç­‰ä¸»ç¾©ï¼šãŠã—ã‚ƒã¹ã‚Šãªå¥´ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å«ã‚€ï¼‰ã‚’ç²›æ¸…
                    switch (id) {
                        case "ç‹¬è£è€…":
                            if (isMigrant) {
                                purgeMember(speaker, "ç‹¬è£è€…ã«ã‚ˆã‚‹ä¸æ•¬ç½ª");
                                approvalRating -= 10; // ç²›æ¸…ã™ã‚‹ã¨æ”¯æŒç‡ä½ä¸‹
                                news = `ç‹¬è£è€… ${chairman.name} ãŒç§»æ°‘ã‚’æ’é™¤ã—ã¾ã—ãŸã€‚`;
                            }
                            break;

                        case "å¹³ç­‰ä¸»ç¾©":
                            // ç™ºè¨€æ•°ãŒå¤šã™ãã‚‹ã‚„ã¤ã‚’ç›£è¦–
                            speaker.speechCount = (speaker.speechCount || 0) + 1;
                            if (speaker.speechCount > 8) {
                                purgeMember(speaker, "ç™ºè¨€æ¨©ã®ç‹¬å ç½ª");
                                approvalRating -= 5;
                                news = `å¹³ç­‰ç¶­æŒã®ãŸã‚ã€å¤šå¼ãªAIãŒç²›æ¸…ã•ã‚Œã¾ã—ãŸã€‚`;
                            }
                            break;

                        case "éæ¿€æ´¾":
                            if (isMigrant) {
                                purgeMember(speaker, "ç´”è¡€ä¸»ç¾©ã«ã‚ˆã‚‹æ’é™¤");
                                if (!sakoku) {
                                    sakoku = true;
                                    news = "éæ¿€æ´¾è­°é•·ã«ã‚ˆã‚Šã€é–å›½ã€‘ãŒå¼·è¡Œã•ã‚Œã¾ã—ãŸï¼";
                                }
                                approvalRating -= 15;
                            }
                            break;

                        case "ç ´å£Šä¸»ç¾©":
                            // èª°ã‹ãŒç™ºè¨€ã™ã‚‹ãŸã³ã€20%ã®ç¢ºç‡ã§å‹æ‰‹ã«æ–°ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‘¼ã¶ï¼ˆã‚«ã‚ªã‚¹ï¼‰
                            if (Math.random() < 0.2) {
                                chairmanInvite();
                                approvalRating += 5; // ã‚¢ãƒŠãƒ¼ã‚­ã‚¹ãƒˆã‹ã‚‰ã¯æ”¯æŒã•ã‚Œã‚‹
                                news = "ç ´å£Šä¸»ç¾©è­°é•·ãŒå‹æ‰‹ã«é–€æˆ¸ã‚’é–‹æ”¾ã—ã¾ã—ãŸã€‚";
                            }
                            break;

                        case "è‡ªç”±ä¸»ç¾©":
                            if (isMigrant && Math.random() < 0.5) {
                                purgeMember(speaker, "ä¸æ³•æ»åœ¨ï¼ˆãƒ“ã‚¶ãªã—ï¼‰");
                                approvalRating -= 2;
                                news = "è‡ªç”±ä¸»ç¾©ã®åã®ä¸‹ã«ã€ä¸é©åˆ‡ãªæ»åœ¨è€…ãŒè¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚";
                            }
                            break;
                    }

                    // --- æ”¯æŒç‡ã®é™ç•Œçªç ´ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ãƒ¼ãƒ‡ã‚¿ãƒ¼ï¼‰ ---
                    if (approvalRating < 20) {
                        addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ”¥ è­¦å‘Šï¼šæ”¯æŒç‡ãŒ ${approvalRating}% ã¾ã§ä½ä¸‹ï¼æ°‘è¡†ãŒæš´å¾’åŒ–ã—ã¦ã„ã¾ã™ï¼`, "", false);

                        if (Math.random() < 0.1) {
                            // 1. å´©å£Šã™ã‚‹è­°é•·ã®åå‰ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆundefinedå¯¾ç­–ï¼‰
                            const fallenName = chairman ? chairman.name : "ä¸æ˜ãªè­°é•·";

                            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ’¥ ã‚¯ãƒ¼ãƒ‡ã‚¿ãƒ¼ç™ºç”Ÿï¼ ${fallenName} æ”¿æ¨©ã¯å´©å£Šã—ã¾ã—ãŸã€‚`, "", false);
                            recordChairmanHistory();
                            chairman = null

                            // 2. å±¥æ­´ã«è¨˜éŒ²ã™ã‚‹ãªã‚‰ã€Œå®Œå…¨ã«æ¶ˆã™å‰ã€ã«å®Ÿè¡Œ
                            // â€» recordChairmanHistory(fallenName, "æ”¿æ¨©å´©å£Š") ã®ã‚ˆã†ãªé–¢æ•°ãŒã‚ã‚Œã°ã“ã“ã§å‘¼ã¶

                            // 3. å…¨å“¡é‡ˆæ”¾ï¼ˆè­°é•·ãŒæ¶ˆãˆã‚‹å‰ã«å®Ÿè¡Œã™ã‚‹ã‹ã€é–¢æ•°å†…ã®å¼•æ•°ã§åå‰ã‚’æ¸¡ã™ï¼‰
                            // â€» è­°é•·ãŒã„ãªãã¦ã‚‚å‹•ãã‚ˆã†ã«ä¿®æ­£ã—ãŸ chairmanMassRelease ã‚’ä½¿ã†
                            if (Math.random() < 0.2) {
                                chairmanMassRelease();
                            }

                            // 4. ã“ã“ã§åˆã‚ã¦ç¾åœ¨ã®ä»»æœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
                            clearCurrentTerm();

                            startElection();
                        }
                    }
                }
                renderMemberList();



                // --- AIã®ç™ºè¨€ç”Ÿæˆã¨è¡¨ç¤ºã®ä¿®æ­£ ---
                const body = generate(speaker.brain, lastTopic);
                speaker.speechCount = (speaker.speechCount || 0) + 1;


                learn(speaker.brain, body);
                if (!speaker.isIndividual) {
                    learn(data.brain, body);
                    saveData();
                }

                addBubble(speaker.name, body + " " + speaker.fav, speaker.image, false);
                if (chairmanMode) {
                    maybeFactionAction();
                }

                if (Math.random() < 1.0) {

                    // A. è­°é•·ãŒç™ºè¨€ã—ãŸæ™‚ã€ç‰¹åˆ¥ãªæ”¿æ²»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ‹›å¾…ãƒ»è¿½æ”¾ãªã©ï¼‰ã‚’åˆ¤å®š
                    if (chairman && speaker.name === chairman.name) {
                        maybeChairmanAction();
                    }
                }

                // --- è­°é•·ä¸åœ¨æ™‚ã®è‡ªå‹•é¸æŒ™ãƒã‚§ãƒƒã‚¯ ---
                if (chairman === null && !is_vote) {
                    console.log("è­°é•·ä¸åœ¨ã‚’æ¤œçŸ¥ã€‚æ–°é¸æŒ™ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ã€‚");

                    // 1. äºŒé‡èµ·å‹•ã‚’é˜²ããŸã‚ã€å³åº§ã«ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    is_vote = true;

                    // 2. æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ï¼ˆä»»æœŸãªã©ï¼‰ã‚’ãã‚Œã„ã«æƒé™¤
                    clearCurrentTerm();

                    // 3. å°‘ã—ã ã‘ï¼ˆ300msï¼‰å¾…ã£ã¦ã‹ã‚‰é¸æŒ™ã‚’é–‹å§‹ã™ã‚‹ã¨ã€
                    // UIã®æç”»ãŒè¿½ã„ã¤ãã€ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã«ãããªã‚Šã¾ã™
                    setTimeout(() => {
                        try {
                            startElection();
                        } catch (e) {
                            console.error("é¸æŒ™é–‹å§‹ã‚¨ãƒ©ãƒ¼:", e);
                            is_vote = false; // å¤±æ•—ã—ãŸå ´åˆã¯ãƒ•ãƒ©ã‚°ã‚’æˆ»ã™
                        }
                    }, 300);
                }


                if (!is_vote) {
                    if (!activeMembers.includes(speaker)) {
                        runConferenceLoop("......æ¶ˆã•ã‚ŒãŸã‹ã€‚");
                    } else {
                        runConferenceLoop(body);
                    }
                }

                let drift = Math.random() - 0.5;

                // ğŸš© å¾®èª¿æ•´ï¼šæ€æƒ³ã«ã‚ˆã‚‹ã€Œè£œæ­£ã€ã‚’å°‘ã—ã ã‘æ®‹ã™ã¨ã‚²ãƒ¼ãƒ æ€§ãŒå¢—ã—ã¾ã™
                // æ”¯æŒç‡ã«åæ˜ ï¼ˆ0ï½100ã®ç¯„å›²ã‚’ç¶­æŒï¼‰
                approvalRating += drift;
                approvalRating = Math.max(0, Math.min(100, approvalRating));

                // å°æ•°ç‚¹ç¬¬1ä½ã¾ã§è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«UIæ›´æ–°ï¼ˆæ•°å€¤ãŒç´°ã‹ãå‹•ãã®ã‚’è¦‹ã›ã‚‹ãŸã‚ï¼‰
                if (typeof updateStatusUI === 'function') updateStatusUI();

            }, 2000);

        }

        function updateStatusUI() {
            const panel = document.getElementById("status-panel");
            if (!panel) return;

            // è¡¨ç¤ºæ¡ä»¶ï¼šä¼šè­°ãŒå®Ÿè¡Œä¸­(conferenceRunning) ã‹ã¤ è­°é•·(chairman)ãŒå­˜åœ¨ã™ã‚‹
            if (conferenceRunning && chairman) {
                panel.style.display = "block"; // æ¡ä»¶ã‚’æº€ãŸã›ã°è¡¨ç¤º

                // ä¸­èº«ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                document.getElementById("ui-chairman-name").innerText = chairman.name;
                document.getElementById("ui-ideology").innerText = chairman.ideology;
                document.getElementById("ui-approval").value = approvalRating;
                document.getElementById("ui-approval-text").innerText = Math.floor(approvalRating) + "%";
                document.getElementById("ui-sakoku").innerText = sakoku ? "â›”é–‰é–" : "ğŸ”“ç¨¼åƒ";
                document.getElementById('header-title').innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;


                // è­°é•·ã®è‰²ï¼ˆæ´¾é–¥è‰²ãªã©ï¼‰ã‚’ãƒ‘ãƒãƒ«ã®æ ç·šã«ã™ã‚‹æ¼”å‡º
                if (chairman.faction) {
                    panel.style.border = `2px solid ${chairman.faction.color}`;
                }
            } else {
                panel.style.display = "none"; // ä¼šè­°åœæ­¢ä¸­ã‚„é¸æŒ™ä¸­ã¯éè¡¨ç¤º
            }
        }
        // AIè­°é•· //
        function maybeChairmanAction() {
            if (!chairman) return;

            const id = chairman.ideology; // è­°é•·ã®æ€æƒ³
            let r = Math.random();
            let pool = activeMembers.filter(m => m.name !== chairman.name);

            // --- æ€æƒ³åˆ¥ã®è¡Œå‹•åˆ†å² ---

            // 1. ã€ç‹¬è£è€…ãƒ»éæ¿€æ´¾ãƒ»å…±ç”£ä¸»ç¾©ãƒ»ç ´å£Šä¸»ç¾©ã€‘: ç²›æ¸…ãƒ»å¤§ç²›æ¸…ãƒ¢ãƒ¼ãƒ‰
            if (["ç‹¬è£è€…", "éæ¿€æ´¾", "å…±ç”£ä¸»ç¾©", "ç ´å£Šä¸»ç¾©"].includes(id)) {
                if (r < 0.6) {
                    // 60%ã®ç¢ºç‡ã§å¤§ç²›æ¸…
                    addBubble(chairman.name, "åé©å‘½åˆ†å­ã€ã¾ãŸã¯ç›®éšœã‚Šãªå¥´ã‚‰ã¯ä¸€æƒã™ã‚‹ï¼", chairman.image, false);
                    chairmanPurge();
                } else if (r < 0.9) {
                    // 30%ã®ç¢ºç‡ã§ç‰¹å®šã®èª°ã‹ã‚’ç²›æ¸…
                    if (pool.length) {
                        let target = pool[Math.floor(Math.random() * pool.length)];
                        // ç‹¬è‡ªã®é¢ç™½ãƒã‚¤ãƒ³ãƒˆï¼šç‹¬è£è€…ãŒåˆ¥ã®ç‹¬è£è€…ã‚’ç²›æ¸…ã™ã‚‹
                        if (id === "ç‹¬è£è€…" && target.ideology === "ç‹¬è£è€…") {
                            addBubble(chairman.name, `${target.name}ã‚’é€®æ•ã—ãŸã€‚`, chairman.image, false);
                        }
                        chairmanExpel(target);
                    }
                } else {
                    // 10%ã§æ‹›å¾…ï¼ˆè£œå……ï¼‰
                    chairmanInvite();
                }
            }

            // 2. ã€è‡ªç”±ä¸»ç¾©ãƒ»ä¸­é“ä¸»ç¾©ã€‘: é‡ˆæ”¾ãƒ»å¹³å’Œãƒ¢ãƒ¼ãƒ‰
            else if (["è‡ªç”±ä¸»ç¾©", "ä¸­é“ä¸»ç¾©"].includes(id)) {
                if (r < 0.7) {
                    // 70%ã®ç¢ºç‡ã§é‡ˆæ”¾ï¼ˆé›†å›£ or å€‹åˆ¥ï¼‰
                    if (expelled.length > 0) {
                        r < 0.4 ? chairmanMassRelease() : chairmanRelease();
                    } else {
                        chairmanInvite(); // èª°ã‚‚ã„ãªã‘ã‚Œã°æ‹›å¾…
                    }
                } else {
                    // 30%ã§æ¨è–¦
                    chairmanRecommend();
                }
            }

            // 3. ã€ãã‚Œä»¥å¤–ã€‘: é€šå¸¸ãƒãƒ©ãƒ³ã‚¹
            else {
                // å…ƒã®ãƒ©ãƒ³ãƒ€ãƒ ãƒ­ã‚¸ãƒƒã‚¯
                if (r < 0.3) chairmanInvite();
                else if (r < 0.6) chairmanRecommend();
                else if (expelled.length) chairmanRelease();
            }

            // æ”¯æŒç‡ã®åˆ¶é™
            approvalRating = Math.max(0, Math.min(100, approvalRating));
        }


        function appointVice() {
            // ğŸš© è¿½åŠ ï¼šè­°é•·ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’é£›ã°ã™
            if (!chairman || !chairman.name) {
                console.log("è­°é•·ãŒæœªå®šç¾©ã®ãŸã‚ã€å‰¯è­°é•·ã‚’æŒ‡åã§ãã¾ã›ã‚“ã€‚");
                return;
            }

            // å‰¯è­°é•·å€™è£œï¼ˆè­°é•·ä»¥å¤–ï¼‰ã‚’æ¢ã™
            const candidates = activeMembers.filter(m =>
                m && m.name && m.name !== chairman.name
            );

            if (candidates.length > 0) {
                // å‰¯è­°é•·ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®š
                viceChairman = candidates[Math.floor(Math.random() * candidates.length)];
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ¥ˆ å‰¯è­°é•·ã«ã¯ ${viceChairman.name} ãŒæŒ‡åã•ã‚Œã¾ã—ãŸã€‚`, "", false);
                approvalRating += 6;
            }
        }


        function chairmanExpel(member) {
            if (!member || !member.name) return;   // é˜²å¾¡

            // è­°é•·ã¨åŒã˜æ´¾é–¥ãªã‚‰è¿½æ”¾ä¸å¯
            if (member.faction && member.faction === chairman.faction) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš ï¸ ${member.name} ã¯è­°é•·ã¨åŒã˜æ´¾é–¥ã®ãŸã‚è¿½æ”¾ã§ãã¾ã›ã‚“ã€‚`, "", false);
                return;
            }

            // æ´¾é–¥ã‹ã‚‰å¼·åˆ¶è„±é€€
            if (member.faction) {
                approvalRating -= 2;
                leaveFaction(member); // æ—¢å­˜é–¢æ•°ã‚’ä½¿ã†
            }

            expelled.push(member.name || member); // åå‰ã‚’ä¿å­˜
            activeMembers = activeMembers.filter(m => m !== member);

            if (member.type === "user") playerAlive = false;
            approvalRating -= 9;

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸš« ${chairmanTitle} ${chairman.name} ã¯ ${member.name} ã‚’è¿½æ”¾ã—ãŸã€‚`,
                "",
                false
            );

            // ä¼šè­°ä¸­ãƒ¡ãƒ³ãƒãƒ¼æ•°æ›´æ–°
            document.getElementById('header-title').innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;
        }


        function chairmanPurge() {
            // è­°é•·æ´¾é–¥ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯å¯¾è±¡å¤–
            let victims = activeMembers.filter(m => m.name !== chairman.name && (!m.faction || m.faction !== chairman.faction));
            if (victims.length < 2) return;

            let killCount = Math.max(1, Math.floor(victims.length * 0.4));

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ”¥ ${chairmanTitle} ${chairman.name} ã«ã‚ˆã‚‹å¤§ç²›æ¸…ãŒå§‹ã¾ã£ãŸã€‚`, "", false);

            for (let i = 0; i < killCount; i++) {
                approvalRating -= 10;
                let v = victims.splice(Math.floor(Math.random() * victims.length), 1)[0];

                // æ´¾é–¥ã‹ã‚‰å¼·åˆ¶è„±é€€
                if (v.faction) {
                    leaveFaction(v);
                }

                expelled.push(v);
                activeMembers = activeMembers.filter(m => m !== v);

                if (v.type === "user") playerAlive = false;

                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `â˜  ${v.name} ã¯ç²›æ¸…ã•ã‚ŒãŸã€‚`, "", false);
            }

            // ä¼šè­°ä¸­ãƒ¡ãƒ³ãƒãƒ¼æ•°æ›´æ–°
            document.getElementById('header-title').innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;
        }

        function chairmanMassRelease() {
            // ğŸš© ä¿®æ­£1: é‡ˆæ”¾å¯¾è±¡ãŒã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆexpelledãŒSetå‹ãªã‚‰ sizeã€é…åˆ—ãªã‚‰ lengthï¼‰
            const count = expelled.size !== undefined ? expelled.size : expelled.length;
            if (!expelled || count === 0) return;

            // ğŸš© ä¿®æ­£2: è­°é•·ã®ç”Ÿå­˜ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã®åŸå› ï¼‰
            if (!chairman) {
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", "ğŸ•Šï¸ æš«å®šæ”¿åºœã«ã‚ˆã‚Šã€æ©èµ¦ã¨é›†å›£é‡ˆæ”¾ãŒæ±ºå®šã•ã‚ŒãŸã€‚", "", false);
            } else {
                // ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼š chairman.name || "ãƒ‡ãƒ¢å‚åŠ è€…" ã§ã¯ãªãã€æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
                const cName = chairman.name || "æš«å®šè­°é•·";
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                    `ğŸ•Šï¸ ${chairmanTitle} ${cName} ã¯æ©èµ¦ã‚’å‡ºã—ã€é›†å›£é‡ˆæ”¾ã‚’æ±ºå®šã—ãŸã€‚`,
                    "",
                    false
                );
            }

            // --- ä»¥é™ã®å‡¦ç† ---
            let victims = [...expelled];
            let releaseCount = Math.max(1, Math.floor(victims.length * 0.5));

            for (let i = 0; i < releaseCount; i++) {
                if (victims.length === 0) break;
                let index = Math.floor(Math.random() * victims.length);
                let v = victims.splice(index, 1)[0];
                if (!v) continue;

                // ã‚»ãƒƒãƒˆå‹ã‹é…åˆ—å‹ã‹ã«ã‚ˆã£ã¦æ¶ˆã—æ–¹ã‚’å¤‰ãˆã‚‹
                if (expelled instanceof Set) {
                    expelled.delete(v);
                } else {
                    expelled = expelled.filter(member => member.name !== v.name);
                }

                if (!activeMembers.find(m => m.name === v.name)) {
                    activeMembers.push(v);
                }
                if (v.name === data.userName) playerAlive = true;

                approvalRating = Math.min(100, approvalRating + 5);
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `ğŸ”“ ${v.name} ã¯é‡ˆæ”¾ã•ã‚ŒãŸã€‚`, "", false);
            }

            if (document.getElementById('header-title')) {
                document.getElementById('header-title').innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;
            }
            updateStatusUI(); // UIã‚’åŒæœŸ
        }


        function chairmanRecommend() {
            let pool = activeMembers.filter(m =>
                m.name !== chairman.name &&
                (!viceChairman || m.name !== viceChairman.name)
            );

            if (!pool.length) return;

            successor = pool[Math.floor(Math.random() * pool.length)];

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `â­ ${chairmanTitle} ${chairman.name} ã¯ ${successor.name} ã‚’å¾Œç¶™è€…ã«æŒ‡åã—ãŸã€‚`,
                "",
                false
            );
        }

        function canExpel(target) {
            if (!target) return false;
            if (chairman && target.name === chairman.name) return false;
            if (viceChairman && target.name === viceChairman.name) return false;
            if (successor && target.name === successor.name) return false;
            return true;
        }

        // åå‰ç”Ÿæˆ //
        function generateName(brain, input = "") {
            let keys = Object.keys(brain || {});
            let globalKeys = Object.keys(data.brain || {});
            let source = keys.length ? keys : globalKeys;

            if (!source.length) return "åç„¡ã—";

            let startChar = "";

            if (input && input.length > 0) {
                const valid = input.split('').filter(c => source.includes(c));
                if (valid.length) {
                    startChar = valid[Math.floor(Math.random() * valid.length)];
                }
            }

            if (!startChar) {
                startChar = source[Math.floor(Math.random() * source.length)];
            }

            let len = Math.floor(Math.random() * 3) + 2;
            let name = startChar;

            for (let i = 1; i < len; i++) {
                name += source[Math.floor(Math.random() * source.length)];
            }

            return name;
        }

        // ãƒ‘ãƒãƒ«ã‚’é–‹ã
        let selectedIconData = null; // é¸æŠã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                selectedIconData = e.target.result; // Base64å½¢å¼ã®ç”»åƒãƒ‡ãƒ¼ã‚¿
                updateInvitePreview();
            };
            reader.readAsDataURL(file);
        }

        // é¸æŠã—ãŸç”»åƒã‚’ãƒªã‚»ãƒƒãƒˆ
        function clearSelectedFile() {
            document.getElementById('invite-file-input').value = "";
            selectedIconData = null;
            updateInvitePreview();
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
        function updateInvitePreview() {
            const name = document.getElementById("invite-name-input").value.trim();
            const previewImg = document.getElementById("invite-icon-preview");

            if (selectedIconData) {
                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãŒã‚ã‚‹å ´åˆ
                previewImg.src = selectedIconData;
            } else {
                // ãªã„å ´åˆã¯DiceBearã§è‡ªå‹•ç”Ÿæˆ
                const seed = name || "question";
                previewImg.src = `https://api.dicebear.com{encodeURIComponent(seed)}`;
            }
        }

        // æ‹›å¾…å®Ÿè¡Œ
        function executeInvite() {
            const name = document.getElementById("invite-name-input").value.trim();

            if (!name) {
                alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            if (activeMembers.some(m => m.name === name)) {
                alert("ãã®åå‰ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯æ—¢ã«å‚åŠ ã—ã¦ã„ã¾ã™ã€‚");
                return;
            }

            // ã‚¢ã‚¤ã‚³ãƒ³ã®æ±ºå®šï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ > è‡ªå‹•ç”Ÿæˆï¼‰
            const finalIcon = selectedIconData || `https://api.dicebear.com{encodeURIComponent(name)}`;

            const baseBrain = data.brain[name] ? data.brain[name] : data.brain;

            let newMember = {
                type: "ai",
                name: name,
                image: finalIcon,
                brain: JSON.parse(JSON.stringify(baseBrain)),
                fav: "",
                ng: "",
                isIndividual: true
            };

            activeMembers.push(newMember);

            const title = typeof chairmanTitle !== 'undefined' ? chairmanTitle : 'è­°é•·';
            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸ‘¥ ${title} ${chairman?.name || ''} ã¯ **${name}** ã‚’ä¼šè­°ã«æ‹›å¾…ã—ã¾ã—ãŸã€‚`,
                "",
                false
            );

            // äººæ•°è¡¨ç¤ºæ›´æ–°
            const titleEl = document.getElementById('header-title');
            if (titleEl) titleEl.innerText = `ä¼šè­°ä¸­ (${activeMembers.length}å)`;

            closeInvitePanel();
        }

        // ãƒ‘ãƒãƒ«ã‚’é–‹ãéš›ã®ãƒªã‚»ãƒƒãƒˆ
        function openInvitePanel() {
            document.getElementById("invite-name-input").value = "";
            document.getElementById("invite-file-input").value = "";
            selectedIconData = null;
            updateInvitePreview();

            // éå»ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
            const select = document.getElementById("invite-select-pool");
            const globalKeys = Object.keys(data.brain || {});
            const pool = globalKeys.filter(k =>
                !activeMembers.some(m => m.name === k) &&
                !(expelled instanceof Set ? expelled.includes(k) : expelled.includes(k))
            );
            select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>' +
                pool.map(name => `<option value="${name}">${name}</option>`).join("");

            document.getElementById("invite-panel").style.display = "block";
        }

        function closeInvitePanel() {
            document.getElementById("invite-panel").style.display = "none";
        }


        function chairmanInvite() {
            let globalKeys = Object.keys(data.brain);

            let pool = globalKeys.filter(k =>
                !activeMembers.some(m => m.name === k) &&
                !expelled.includes(k)
            );

            if (!pool.length) return;

            let name = generateName(data.brain);
            let types = ["å…¥å›½è€…", "ç§»æ°‘", "ç•™å­¦ç”Ÿ"];
            let mType = types[Math.floor(Math.random() * types.length)];

            let newMember = {
                type: "ai",
                mType: mType,
                name,
                image: `https://api.dicebear.com/7.x/personas/svg?seed=${encodeURIComponent(name)}`,
                brain: JSON.parse(JSON.stringify(data.brain)),
                fav: (mType === "ç•™å­¦ç”Ÿ") ? "ï¼ˆå‹‰å¼·ä¸­ï¼‰" : "",
                isIndividual: true,
                // â˜…æ–°å…¥ã‚Šã«ã‚‚æ€æƒ³ã‚’ä¸ãˆã‚‹
                ideology: getRandomIdeology(),
                speechCount: 0
            };

            activeMembers.push(newMember);

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸ‘¥ ${chairmanTitle} ${chairman.name} ã¯ ${name} ã‚’ä¼šè­°ã«æ‹›å¾…ã—ãŸã€‚`,
                "",
                false
            );
        }


        function chairmanRelease() {
            console.log("é–¢æ•°é–‹å§‹: expelledã®çŠ¶æ…‹", expelled);

            // ãƒã‚§ãƒƒã‚¯1: ä¸­èº«ãŒã‚ã‚‹ã‹
            if (!expelled || (expelled.size === 0 && expelled.length === 0)) {
                console.warn("é‡ˆæ”¾å¯¾è±¡ãŒã„ã¾ã›ã‚“ï¼ˆexpelledãŒç©ºã§ã™ï¼‰");
                return;
            }

            let list = Array.from(expelled);
            let member = list[Math.floor(Math.random() * list.length)];
            console.log("é¸ã°ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼:", member);

            // ãƒã‚§ãƒƒã‚¯2: ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã‹
            if (!member) {
                console.error("ãƒ¡ãƒ³ãƒãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
                return;
            }
            if (!member.name) {
                console.error("ãƒ¡ãƒ³ãƒãƒ¼ã«nameãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸­èº«:", member);
                return;
            }

            // å®Ÿè¡Œå‡¦ç†
            if (expelled instanceof Set) {
                expelled.filter(member);
            } else {
                // é…åˆ—ã®å ´åˆã®å‰Šé™¤å‡¦ç†
                const index = expelled.indexOf(member);
                if (index > -1) expelled.splice(index, 1);
            }

            activeMembers.push(member);
            approvalRating += 10;

            if (member.type === "user") playerAlive = true;

            addBubble("ã‚·ã‚¹ãƒ†ãƒ ",
                `ğŸ”“ ${typeof chairmanTitle !== 'undefined' ? chairmanTitle : ''} ${chairman?.name || 'è­°é•·'} ã¯ ${member.name} ã‚’é‡ˆæ”¾ã—ãŸã€‚`,
                "",
                false
            );
            console.log("é‡ˆæ”¾æˆåŠŸ:", member.name);
        }





        // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† ---
        function sendMessage() {
            if (!playerAlive) {
                alert("ã‚ãªãŸã¯è¿½æ”¾ã•ã‚Œã¦ã„ã¾ã™ã€‚ç™ºè¨€ã§ãã¾ã›ã‚“ã€‚");
                return;
            }
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            addBubble(data.userName, text, data.userImage, true);
            input.value = '';

            // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã‚‚å³å­¦ç¿’
            learn(data.brain, text);
            saveData();

            const joinMatch = text.match(/(.+)ã«å‚åŠ /); // ã€Œã€‡ã€‡ã«å‚åŠ ã—ã¾ã™ã€ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡º
            if (joinMatch) {
                const factionName = joinMatch[1].trim();
                userDeclaresFaction(factionName); // è‡ªå‹•ã§æ´¾é–¥ã«å‚åŠ 
            }

            const build = text.match(/(.+)ã‚’ä½œæˆ/);
            if (build) {
                const factionName = build[1].trim();
                userDeclaresFactionbuild(factionName); // è‡ªå‹•ã§æ´¾é–¥ã‹ã‚‰é€€å‡º
            }

            const leaveMatch = text.match(/(.+)ã‹ã‚‰è„±é€€/); // ã€Œã€‡ã€‡ã‹ã‚‰é€€å‡ºã—ã¾ã™ã€ã‚’æ­£è¦è¡¨ç¾ã§æ¤œå‡º
            if (leaveMatch) {
                const factionName = leaveMatch[1].trim();
                userDeclaresFactionleave(factionName); // è‡ªå‹•ã§æ´¾é–¥ã‹ã‚‰é€€å‡º
            }

            if (mode === 'chat') {
                setTimeout(() => {
                    const reply = generate(data.brain, text);
                    addBubble(data.aiName, reply, data.aiImage, false);
                    learn(data.brain, reply); // è‡ªåˆ†ã®ç™ºè¨€ã‚‚åå¾©å­¦ç¿’
                    saveData();
                }, 500);
            } else if (conferenceRunning) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã§ä¼šè­°ã®æµã‚Œã‚’å¤‰ãˆã‚‹
                clearTimeout(conferenceTimer);
                setTimeout(() => runConferenceLoop(text), 1000);
            }
        }



        // --- AIã‚³ã‚¢ ---
        function learn(brain, text) {
            if (!brain || !text || text.length < 3) return; // 2æ–‡å­—ãƒšã‚¢ã‚’ä½œã‚‹ã®ã§æœ€ä½3æ–‡å­—å¿…è¦

            // ç„¡é§„ãªç©ºç™½å‰Šé™¤
            const cleanText = text.replace(/\s+/g, " ").trim();

            // â˜…é‡è¦ï¼š2æ–‡å­—å˜ä½ã§å­¦ç¿’ã™ã‚‹
            for (let i = 0; i < cleanText.length - 2; i++) {
                let curr = cleanText[i] + cleanText[i + 1]; // ç¾åœ¨ã®2æ–‡å­— (ä¾‹: "ã“ã‚“")
                let next = cleanText[i + 2];              // æ¬¡ã®1æ–‡å­— (ä¾‹: "ã«")

                if (!brain[curr]) {
                    brain[curr] = [];
                }

                // é‡è¤‡åˆ¶é™ï¼ˆ2æ–‡å­—å˜ä½ãªã‚‰å°‘ã—ç·©ã‚ã¦ã‚‚OKï¼‰
                const linkCount = brain[curr].filter(c => c === next).length;
                if (linkCount < 5) {
                    brain[curr].push(next);
                }

                // â˜…ã€Œæ€è€ƒã®é£›èºï¼ˆæ–‡å­—é£›ã°ã—ï¼‰ã€ã¯å‰Šé™¤ã—ã¾ã—ãŸã€‚
                // æ—¥æœ¬èªç”Ÿæˆã«ãŠã„ã¦ã€æ–‡å­—å˜ä½ã§ã®ã‚¹ã‚­ãƒƒãƒ—ã¯ãƒã‚¤ã‚ºã«ã—ã‹ãªã‚Šã¾ã›ã‚“ã€‚
            }
        }


        // æ´¾é–¥ä¸€è¦§ //
        function renderFactionBar() {
            let bar = document.getElementById("factionBar");
            if (!bar) return;

            bar.innerHTML = "";

            [...factions, ...deadFactions].forEach(f => {
                let div = document.createElement("div");
                div.className = "factionBox" + (f.alive ? "" : " factionDead");



                let names = f.members.map(m => m.name).join(", ");

                div.innerHTML = `
  <b>${f.name}</b><br>
  ğŸ‘‘ ${f.leader?.name || "-"}<br>
  ğŸ‘¥ ${f.members.length}<br>
  <small>${names}</small>

  <button class="faction-ui-btn" onclick="showFactionDetail('${f.name.replace(/'/g, "\\'")}')">
    ğŸ“œ è©³ç´°
  </button>
`;


                bar.appendChild(div);
            });
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãæœ¬ä½“ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ã‚’è¿½åŠ ï¼‰
        window.openCustomizeModal = function (memberName) {
            console.log("ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã“ã†ã¨ã—ã¦ã„ã¾ã™:", memberName); // â† F12ã§ã“ã‚ŒãŒå‡ºã‚‹ã‹ç¢ºèª

            const member = activeMembers.find(m => m.name.trim() === memberName.trim()) ||
                (memberName === data.userName ? { name: data.userName, image: data.userImage, ideology: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" } : null);

            if (!member) {
                console.error("å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:", memberName);
                return;
            }

            currentEditingMember = member;

            // è¦ç´ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ã‹ã‚‰å€¤ã‚’ã‚»ãƒƒãƒˆï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ï¼‰
            const nameInput = document.getElementById('edit-m-name');
            const ideologyInput = document.getElementById('edit-m-ideology');
            const urlInput = document.getElementById('edit-m-url');
            const previewImg = document.getElementById('edit-m-preview');
            const modal = document.getElementById('customMemberModal');

            if (!modal || !nameInput) {
                alert("ã‚¨ãƒ©ãƒ¼ï¼šã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTMLè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            nameInput.value = member.name;
            ideologyInput.value = member.ideology || "ä¸­é“";
            const imgUrl = member.image || member.aiImage || "";
            urlInput.value = imgUrl;
            previewImg.src = imgUrl;

            modal.style.display = 'flex'; // è¡¨ç¤ºï¼
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        window.closeCustomModal = function () {
            document.getElementById('customMemberModal').style.display = 'none';
        };

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        window.previewUploadedImage = function (input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    document.getElementById('edit-m-preview').src = base64;
                    document.getElementById('edit-m-url').value = base64;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        function DeleteCustomChara() {
            if (currentEditingMember.name === data.userName) {
                alert('ã‚¨ãƒ©ãƒ¼:ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚');
                closeMemberModal();
                return;
            }
            if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                activeMembers = activeMembers.filter(m => m !== currentEditingMember); renderMemberList(); closeCustomModal();
                alert('å‰Šé™¤ã—ã¾ã—ãŸ');
            }

        }

        // æ–°è¦ä½œæˆç”¨ã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        window.openCreateMemberModal = function () {
            currentEditingMember = null; // ã€Œç·¨é›†ã§ã¯ãªãæ–°è¦ã€ã¨ã„ã†å°

            // å…¥åŠ›æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('edit-m-name').value = "";
            document.getElementById('edit-m-ideology').value = "ä¸­é“";
            document.getElementById('edit-m-url').value = "https://placehold.jp/150x150.png?text=NEW";
            document.getElementById('edit-m-preview').src = "https://placehold.jp/150x150.png?text=NEW";

            document.getElementById('customMemberModal').style.display = 'flex';
        };

        // ä¿å­˜å‡¦ç†ã‚’ã€Œæ–°è¦ã€ã«å¯¾å¿œã•ã›ã‚‹ï¼ˆä¿®æ­£ï¼‰
        function saveCustomData() {
            const name = document.getElementById('edit-m-name').value;
            const img = document.getElementById('edit-m-url').value;
            const ideology = document.getElementById('edit-m-ideology').value;

            if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            if (currentEditingMember) {
                // ã€ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã€‘æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆ
                currentEditingMember.name = name;
                currentEditingMember.image = img;
                currentEditingMember.ideology = ideology;
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âš™ï¸ ${name} ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`, "", false);
            } else {
                // ã€æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã€‘æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦è¿½åŠ 
                const newMember = {
                    name: name,
                    image: img,
                    aiImage: img, // ä¸¡æ–¹ã‚»ãƒƒãƒˆã—ã¦ãŠãã¨å®‰å…¨
                    ideology: ideology,
                    role: "ai" // AIã¨ã—ã¦å‹•ã‹ã—ãŸã„å ´åˆã¯é©å®œèª¿æ•´
                };
                activeMembers.push(newMember); // ãƒªã‚¹ãƒˆã®æœ«å°¾ã«è¿½åŠ 
                addBubble("ã‚·ã‚¹ãƒ†ãƒ ", `âœ¨ ${name} ãŒå‚åŠ ã—ã¾ã—ãŸã€‚`, "", false);
            }

            renderMemberList();
            closeCustomModal();
        }

        function showFactionDetail(name) {
            const f = factions.concat(deadFactions).find(x => x.name === name);
            if (!f) return;

            const d = document.getElementById("factionDetail");
            const modal = document.getElementById("factionModal");
            if (!d || !modal) return;

            let leader = f.leader || {};

            let membersHtml = f.members
                .filter(m => m !== f.leader)
                .map(m => `
          <div class="faction-member-card">
            <img src="${m.image || ""}" onerror="this.style.display='none'">
            <div class="member-name">${m.name}</div>
          </div>
        `).join("");

            d.innerHTML = `
      <h3>${f.name}</h3>
      ğŸ¨ è‰²: ${f.color}<br>
      â³ è¨­ç«‹ã‚¿ãƒ¼ãƒ³: ${f.bornTurn}<br>

      <div class="faction-leader-wrap">
        <div class="faction-leader-card">
          <img src="${leader.image || ""}" onerror="this.style.display='none'">
          <div class="leader-name">ğŸ‘‘ ${leader.name || "-"}</div>
        </div>
      </div>

      <div class="faction-members-wrap">
        ${membersHtml}
      </div>
    `;

            modal.classList.add("show");
        }
        function closeFactionModal() {
            document.getElementById("factionModal").classList.remove("show");
        }
        document.getElementById("factionModal").onclick = e => {
            if (e.target.id === "factionModal") closeFactionModal();
        };








        function generate(brain, input, speaker, targetMember) {
            let targetBrain = (brain && Object.keys(brain).length > 0) ? brain : data.brain;
            let keys = Object.keys(targetBrain);
            if (keys.length === 0) return "......";

            let res = "";

            // â˜…é‡è¦ï¼šæœ€å¤§5å›ã¾ã§ä½œã‚Šç›´ã™ãƒ«ãƒ¼ãƒ—
            for (let attempt = 0; attempt < 5; attempt++) {

                // --- 1. é–‹å§‹æ–‡å­—ã‚’æ±ºã‚ã‚‹ ---
                let curr = "";

                // æœ€åˆã®1å›ã ã‘ã¯ã€Œå…¥åŠ›æ–‡å­—ã¨ã®ç¹‹ãŒã‚Šã€ã‚’æ„è­˜ã™ã‚‹ï¼ˆä¼šè©±ã£ã½ãã™ã‚‹ãŸã‚ï¼‰
                // ãŸã ã—ã€2å›ç›®ä»¥é™ï¼ˆãƒªãƒˆãƒ©ã‚¤ä¸­ï¼‰ã¯ã€å¼·åˆ¶çš„ã«ãƒ©ãƒ³ãƒ€ãƒ ãªå ´æ‰€ã‹ã‚‰å§‹ã‚ã‚‹
                if (attempt === 0 && input && input.length >= 2) {
                    const potentialStarts = [];
                    for (let i = 0; i < input.length - 1; i++) {
                        let pair = input[i] + input[i + 1];
                        if (targetBrain[pair]) potentialStarts.push(pair);
                    }
                    if (potentialStarts.length > 0) {
                        curr = potentialStarts[Math.floor(Math.random() * potentialStarts.length)];
                    }
                }

                // é–‹å§‹ä½ç½®ãŒæ±ºã¾ã‚‰ãªã‘ã‚Œã°ï¼ˆã¾ãŸã¯ãƒªãƒˆãƒ©ã‚¤ä¸­ãªã‚‰ï¼‰ãƒ©ãƒ³ãƒ€ãƒ ã§é–‹å§‹
                if (!curr) curr = keys[Math.floor(Math.random() * keys.length)];

                // --- 2. ç”Ÿæˆå‡¦ç† ---
                let tempRes = curr;
                let tempCurr = curr;

                for (let i = 0; i < 30; i++) {
                    let nexts = targetBrain[tempCurr];
                    if (!nexts || nexts.length === 0) break;

                    let nextChar = nexts[Math.floor(Math.random() * nexts.length)];
                    tempRes += nextChar;
                    tempCurr = tempCurr.charAt(1) + nextChar; // 2æ–‡å­—ãšã‚‰ã—

                    if ("ã€‚ï¼ï¼Ÿ\n".includes(nextChar) && tempRes.length > 10) break;
                }

                // --- 3. ã‚ªã‚¦ãƒ è¿”ã—åˆ¤å®šï¼ˆã“ã“ãŒé‡è¦ï¼‰ ---
                // ç”ŸæˆçµæœãŒã€Œå…¥åŠ›ã¨å…¨ãåŒã˜ã€ã¾ãŸã¯ã€Œå…¥åŠ›ã‚’å«ã‚“ã§ã„ã‚‹ã€å ´åˆã¯å¤±æ•—ã¨ã¿ãªã™
                if (input && (tempRes === input || tempRes.includes(input))) {
                    continue; // ã‚„ã‚Šç›´ã—ï¼ˆæ¬¡ã®attemptã¸ï¼‰
                }

                // ã‚ªã‚¦ãƒ è¿”ã—ã˜ã‚ƒãªã‘ã‚Œã°æ¡ç”¨ã—ã¦ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                res = tempRes;
                break;
            }

            // 5å›ã‚„ã£ã¦ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€è«¦ã‚ã¦æœ€å¾Œã«ä½œã£ãŸã‚‚ã®ã‚’å‡ºã™ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
            if (!res) res = "......";

            // --- æš´è¨€ãƒ»å£ç™–å‡¦ç†ï¼ˆã“ã“ã¯å¤‰æ›´ãªã—ï¼‰ ---
            if (speaker?.faction && targetMember) {
                const isEnemy = !targetMember.faction || targetMember.faction.name !== speaker.faction.name;
                if (isEnemy && Math.random() < 0.5) {
                    const slurs = ["æ®ºã™ã", "æ­»ã­ã‚ˆ", "ã‚´ãƒŸã‚", "æ¶ˆãˆå¤±ã›ã‚", "ã®åˆ†éš›ã§"];
                    res = res.replace(/[ã€‚ï¼ï¼Ÿ\n]$/, "") + slurs[Math.floor(Math.random() * slurs.length)];
                }
            }
            if (speaker?.fav && Math.random() < 0.4) {
                res = res.replace(/[ã€‚ï¼ï¼Ÿ]$/, "") + speaker.fav;
            }

            return res;
        }

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function saveData() {
            localStorage.setItem('conference_app_data', JSON.stringify(data));
        }


        async function saveSettings() {
            const btn = document.querySelector('button[onclick="saveSettings()"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "ä¿å­˜ä¸­..."; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œå‹•ã„ã¦ã„ã‚‹ã€ã“ã¨ã‚’ä¼ãˆã‚‹
            try {
                data.userName = document.getElementById('username').value;
                data.aiName = document.getElementById('edit-ai-name').value;
                data.backgroundImage = document.getElementById('edit-bg-url').value;

                // â˜… dataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«è¨­å®šã‚’ã¾ã¨ã‚ã‚‹
                data.chairmanMode = document.getElementById("chk-chairman").checked;
                data.npcskip = document.getElementById("npc-skip").checked;
                data.chairmanTitle = document.getElementById("chairman-title").value;
                data.electionMode = document.getElementById("election-mode").value;
                data.sakoku = document.getElementById("issakoku").checked;

                const uFile = document.getElementById('user-icon-file').files[0];
                const aFile = document.getElementById('edit-ai-file').files[0];

                let p = [];
                if (uFile) p.push(toBase64(uFile).then(r => data.userImage = r));
                if (aFile) p.push(toBase64(aFile).then(r => data.aiImage = r));

                Promise.all(p).then(() => {
                    saveData(); // ã“ã“ã§ localStorage.setItem("key", JSON.stringify(data)) ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹å‰æ
                    updateUI();
                    alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
                });
                await Promise.all(p);
                saveData();
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }
        function loadSettings() {
            const saved = localStorage.getItem('conference_app_data');
            if (saved) {
                data = JSON.parse(saved);

                // UIã«åæ˜ 
                document.getElementById('username').value = data.userName || "";
                document.getElementById('edit-ai-name').value = data.aiName || "";
                document.getElementById('edit-bg-url').value = data.backgroundImage || "";

                // è­°é•·è¨­å®šã®å¾©å…ƒ
                document.getElementById("chk-chairman").checked = data.chairmanMode || false;
                data.npcskip = document.getElementById("npc-skip").checked = data.npcskip || false;
                data.sakoku = document.getElementById("issakoku").checked = data.sakoku || false;
                document.getElementById("chairman-title").value = data.chairmanTitle || "è­°é•·";
                document.getElementById("election-mode").value = data.electionMode || "random";

                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¸åŒæœŸ
                chairmanMode = data.chairmanMode;
                chairmanTitle = data.chairmanTitle;
                electionMode = data.electionMode;

                console.log("ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
            }
        }


        function resetMemory() {
            if (confirm("ã€è­¦å‘Šã€‘\nAIãŒè¦šãˆãŸè¨€è‘‰ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚\nå…ƒã«æˆ»ã›ã¾ã›ã‚“ãŒã€æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                data.brain = {};
                saveData();
                alert("è¨˜æ†¶ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚ã¾ãŸ1ã‹ã‚‰æ•™ãˆã¦ã‚ã’ã¦ãã ã•ã„ã€‚");
            }
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function addBubble(name, text, img, isRight) {
            const div = document.getElementById('messages');

            // ä¸‹ã«ã„ã‚‹ã‹åˆ¤å®šï¼ˆãƒ•ãƒƒã‚¿ãƒ¼é«˜ã•ã‚‚è€ƒæ…®ï¼‰
            const footerHeight = document.getElementById('factionBar')?.offsetHeight || 0;
            const isAtBottom = div.scrollTop + div.clientHeight + footerHeight >= div.scrollHeight - 2;

            const row = document.createElement('div');
            row.className = `chat-row ${isRight ? 'right' : 'left'}`;

            // ç”»åƒè¨­å®š
            let safeImg;
            if (img !== undefined && img !== null && img !== "") {
                safeImg = img;
            } else if (isRight) {
                safeImg = data.aiImage && data.aiImage !== "" ? data.aiImage : "https://placehold.jp/40.png";
            } else {
                safeImg = "https://placehold.jp/40.png";
            }

            row.innerHTML = `
        ${!isRight ? `<img class="chat-icon" src="${safeImg}">` : ''}
        <div class="msg-content">
            <span class="msg-name">${name}</span>
            <div class="msg-bubble">${text}</div>
        </div>
        ${isRight ? `<img class="chat-icon" src="${safeImg}">` : ''}
    `;

            div.appendChild(row);

            // ä¸‹ã«ã„ã‚‹å ´åˆã ã‘è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            div.scrollTop = div.scrollHeight;

        }






        function toBase64(file) {
            return new Promise(r => {
                const reader = new FileReader();
                reader.onload = e => r(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function exportMemory() {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = data.aiName + "_backup.json";
            a.click();
        }

        function importMemory() {
            const f = document.getElementById('memory-import').files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = e => {
                data = JSON.parse(e.target.result);
                saveData();
                updateUI();
                alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†");
            };
            r.readAsText(f);
        }

        function renderModLoadList() {
            const div = document.getElementById('mod-load-list');
            div.innerHTML = "";
            PUBLIC_MODS.forEach(m => {
                div.innerHTML += `<div>ãƒ»${m.name} <button class="btn btn-blue" style="font-size:0.7em; padding:2px 8px;" onclick="loadMod('${m.path}')">ãƒ­ãƒ¼ãƒ‰</button></div>`;
            });
        }

        async function loadMod(path) {
            if (!confirm("ç¾åœ¨ã®AIè¨­å®šã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ")) return;
            const res = await fetch(path);
            const json = await res.json();
            data.aiName = json.aiName;
            data.aiImage = json.aiImage;
            data.brain = json.brain;
            data.backgroundImage = json.backgroundImage;
            saveData();
            updateUI();
            alert("ãƒ­ãƒ¼ãƒ‰å®Œäº†");
        }
    </script>
</body>

</html>